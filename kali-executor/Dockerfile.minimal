# NeuroSploit SaaS v2 - Minimal Kali Container for Testing
# Faster build with essential tools only

FROM kalilinux/kali-rolling:latest

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Core tools + build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl wget git vim \
    python3 python3-pip python3-dev \
    build-essential gcc \
    nmap nikto gobuster sqlmap hydra \
    netcat-traditional dnsutils whois \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Python dependencies (install in stages to handle failures)
RUN pip3 install --break-system-packages --no-cache-dir \
    requests httpx fastapi uvicorn pydantic

RUN pip3 install --break-system-packages --no-cache-dir \
    litellm || pip3 install --break-system-packages --no-cache-dir openai anthropic

RUN pip3 install --break-system-packages --no-cache-dir \
    open-interpreter || echo "Open Interpreter install skipped"

# Copy agent code
COPY open-interpreter/ /opt/neurosploit/

# Create symlinks for AI tools (websearch, docslookup, download)
RUN chmod +x /opt/neurosploit/tools/*.py && \
    ln -sf /opt/neurosploit/tools/websearch.py /usr/local/bin/websearch && \
    ln -sf /opt/neurosploit/tools/docslookup.py /usr/local/bin/docslookup && \
    ln -sf /opt/neurosploit/tools/download.py /usr/local/bin/download

WORKDIR /pentest
RUN mkdir -p /pentest/logs /pentest/output /pentest/memory

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Set Python path
ENV PYTHONPATH="/opt/neurosploit:$PYTHONPATH"

# API keys for web search tools (set at runtime via docker run -e)
ENV TAVILY_API_KEY=""
ENV TRAVERSAAL_API_KEY=""

EXPOSE 9000

ENTRYPOINT ["/entrypoint.sh"]
CMD ["python3", "/opt/neurosploit/dynamic_agent.py", "--help"]
