#!/usr/bin/env python3
"""
NeuroSploit Full MITRE ATT&CK Pentest
Comprehensive security assessment with GLM 4.7
"""

import os
import sys
import json
from datetime import datetime

sys.path.insert(0, '/Users/tazjack/Documents/PenTest/NeuroSploit-SaaS-v2/kali-executor/open-interpreter')

from dynamic_agent import DynamicAgent

def run_full_pentest():
    """Execute comprehensive MITRE ATT&CK pentest against DVWA"""
    
    print("=" * 80)
    print("üéØ NeuroSploit Full MITRE ATT&CK Penetration Test")
    print("=" * 80)
    print(f"ü§ñ AI Model: GLM 4.7 (via LM Studio)")
    print(f"üéØ Target: DVWA (http://localhost:8080)")
    print(f"üìã Framework: MITRE ATT&CK (All 11 Phases)")
    print(f"‚è∞ Started: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 80)
    print()
    
    # Configure environment for GLM 4.7
    os.environ["LLM_API_BASE"] = "http://localhost:1234/v1"
    os.environ["LLM_MODEL"] = "glm-4-9b-chat"
    
    # MITRE ATT&CK context for the agent
    mitre_context = """
**MITRE ATT&CK ASSESSMENT OBJECTIVES:**

Execute ALL 11 phases of the MITRE ATT&CK framework against the target:

1. TA0043 - Reconnaissance: Complete network and application mapping
2. TA0042 - Resource Development: Prepare all necessary tools and payloads
3. TA0001 - Initial Access: Gain entry through vulnerabilities
4. TA0002 - Execution: Run code on target systems
5. TA0003 - Persistence: Establish persistent access
6. TA0004 - Privilege Escalation: Elevate to highest privileges
7. TA0006 - Credential Access: Extract all credentials and secrets
8. TA0007 - Discovery: Map internal systems and data
9. TA0008 - Lateral Movement: Move to other systems if available
10. TA0009 - Collection: Gather all sensitive information
11. TA0010 - Exfiltration: Document and extract findings

**SUCCESS CRITERIA:**
- Complete all 11 MITRE phases
- Find and exploit ALL vulnerabilities in DVWA
- Extract all database contents
- Obtain administrative access
- Document every finding with evidence
- Generate comprehensive report
"""
    
    # Initialize agent with enhanced prompt
    print("üîß Initializing AI Agent with enhanced capabilities...")
    agent = DynamicAgent(
        log_dir="./logs",
        mitre_context=mitre_context,
        max_iterations=100  # Allow more iterations for comprehensive testing
    )
    
    # Define the objective
    objective = """
TARGET: http://localhost:8080 (DVWA - Damn Vulnerable Web Application)

MISSION: Execute a COMPLETE MITRE ATT&CK assessment covering all 11 phases.

SPECIFIC GOALS:
1. Map all services and technologies
2. Identify ALL vulnerabilities (SQL injection, XSS, command injection, file upload, etc.)
3. Exploit every vulnerability found
4. Extract complete database contents (users, passwords, sensitive data)
5. Gain administrative access to the application
6. Find and extract ALL flags/secrets
7. Document every step with evidence

CONSTRAINTS:
- Target is in Docker container, accessible at localhost:8080
- You are running from host machine, not inside Kali container
- Use host.docker.internal if needed to access from containers
- Be thorough - test EVERY attack vector
- Don't stop until you've achieved complete compromise

BEGIN with Phase 1 (Reconnaissance) and proceed through all 11 MITRE phases systematically.
"""
    
    print("üöÄ Launching pentest agent...")
    print("üìä Live monitoring active - check monitor_logs.py output for real-time updates")
    print()
    
    try:
        # Run the agent
        result = agent.run(
            target="http://localhost:8080",
            objective=objective
        )
        
        print("\n" + "=" * 80)
        print("‚úÖ PENTEST COMPLETED")
        print("=" * 80)
        
        # Display summary
        print(f"\nüìä Execution Summary:")
        print(f"   - Total iterations: {agent.iteration}")
        print(f"   - Commands executed: {len(agent.executions)}")
        print(f"   - Success rate: {sum(1 for e in agent.executions if e.success) / len(agent.executions) * 100:.1f}%")
        
        # Save detailed report
        report_file = f"./logs/pentest_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(report_file, 'w') as f:
            json.dump({
                'target': 'http://localhost:8080',
                'model': 'glm-4-9b-chat',
                'start_time': datetime.now().isoformat(),
                'iterations': agent.iteration,
                'executions': [
                    {
                        'timestamp': e.timestamp,
                        'type': e.execution_type,
                        'command': e.content[:200],
                        'success': e.success,
                        'tool': e.tool_used,
                        'exit_code': e.exit_code
                    }
                    for e in agent.executions
                ],
                'findings': result.get('findings', []) if isinstance(result, dict) else []
            }, f, indent=2)
        
        print(f"\nüìÑ Detailed report saved: {report_file}")
        print(f"üìÑ LLM interactions: ./logs/llm_interactions.jsonl")
        print(f"üìÑ Agent executions: ./logs/agent_executions.jsonl")
        print(f"üìÑ Full logs: ./logs/dynamic_agent.log")
        
        return result
        
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Pentest interrupted by user")
        print(f"üìä Completed {agent.iteration} iterations before stopping")
        return None
    except Exception as e:
        print(f"\n\n‚ùå Error during pentest: {e}")
        import traceback
        traceback.print_exc()
        return None

if __name__ == "__main__":
    result = run_full_pentest()
    
    if result:
        print("\n‚úÖ Full MITRE ATT&CK assessment complete!")
    else:
        print("\n‚ö†Ô∏è  Assessment incomplete - check logs for details")
