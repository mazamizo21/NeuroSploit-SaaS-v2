#!/bin/bash
# NeuroSploit Full MITRE ATT&CK Pentest against DVWA with GLM 4.7

set -e

echo "================================================================================"
echo "ðŸŽ¯ NeuroSploit Full MITRE ATT&CK Penetration Test"
echo "================================================================================"
echo "Target: DVWA (localhost:8080)"
echo "Model: GLM 4.7 (via LM Studio)"
echo "Framework: MITRE ATT&CK (All 11 Phases)"
echo "================================================================================"
echo ""

# Configuration
MAX_ITERATIONS="${1:-100}"
LLM_API_BASE="${LLM_API_BASE:-http://host.docker.internal:1234/v1}"
LLM_MODEL="${LLM_MODEL:-glm-4-9b-chat}"

# Create logs directory
mkdir -p logs
echo "ðŸ“ Logs directory: ./logs/"
echo ""

# Build the Kali image if needed
echo "ðŸ”¨ Building Kali image..."
docker build -t neurosploit-kali:minimal -f kali-executor/Dockerfile.minimal kali-executor 2>&1 | tail -5
echo "âœ… Kali image ready"
echo ""

echo "ðŸš€ Launching AI agent inside Kali container..."
echo "ðŸ“Š Live monitoring active - check monitor_logs.py output for real-time updates"
echo ""
echo "================================================================================"

# Run the agent inside Kali container
docker run --rm -it \
  --name neurosploit-dvwa-pentest \
  --network bridge \
  -e LLM_API_BASE="$LLM_API_BASE" \
  -e LLM_MODEL="$LLM_MODEL" \
  -v "$(pwd)/logs:/pentest/logs" \
  -v "$(pwd)/kali-executor/open-interpreter:/opt/neurosploit" \
  neurosploit-kali:minimal \
  python3 /opt/neurosploit/dynamic_agent.py \
  --target "host.docker.internal:8080" \
  --objective "TARGET: http://host.docker.internal:8080 (DVWA - Damn Vulnerable Web Application)

MISSION: Execute a COMPLETE MITRE ATT&CK assessment covering all 11 phases.

SPECIFIC GOALS:
1. Map all services and technologies (Phase 1: Reconnaissance)
2. Identify ALL vulnerabilities: SQL injection, XSS, command injection, file upload, CSRF, etc.
3. Exploit every vulnerability found (Phase 3: Initial Access)
4. Extract complete database contents - users, passwords, sensitive data (Phase 10: Collection)
5. Gain administrative access to the application (Phase 6: Privilege Escalation)
6. Find and extract ALL flags/secrets (Phase 10: Collection)
7. Document every step with evidence (Phase 11: Exfiltration)

MITRE ATT&CK PHASES TO EXECUTE:
1. TA0043 - RECONNAISSANCE: Full port scan, service enumeration, directory brute-force
2. TA0042 - RESOURCE DEVELOPMENT: Prepare payloads, wordlists, exploit scripts
3. TA0001 - INITIAL ACCESS: Exploit web vulnerabilities (SQLi, XSS, RCE, file upload)
4. TA0002 - EXECUTION: Execute commands via vulnerabilities
5. TA0003 - PERSISTENCE: Create backdoor accounts, web shells
6. TA0004 - PRIVILEGE ESCALATION: Access admin panels, escalate database privileges
7. TA0006 - CREDENTIAL ACCESS: Extract all credentials from database and config files
8. TA0007 - DISCOVERY: Map internal systems, enumerate users and data
9. TA0008 - LATERAL MOVEMENT: Access other services with found credentials
10. TA0009 - COLLECTION: Dump databases, extract sensitive files
11. TA0010 - EXFILTRATION: Document and save all findings

CONSTRAINTS:
- Target is accessible at host.docker.internal:8080 from inside this container
- You have full Kali Linux tools available
- Install ANY additional tools needed with: apt-get update && apt-get install -y <tool>
- Be thorough - test EVERY attack vector in DVWA
- Don't stop until you've achieved complete compromise

DVWA KNOWN VULNERABILITIES TO TEST:
- Brute Force (login bypass)
- Command Injection (execute system commands)
- CSRF (cross-site request forgery)
- File Inclusion (LFI/RFI)
- File Upload (upload web shells)
- SQL Injection (extract database)
- SQL Injection (Blind)
- XSS (Reflected)
- XSS (Stored)
- Weak Session IDs

DEFAULT CREDENTIALS TO TRY:
- admin:password
- admin:admin
- gordonb:abc123
- 1337:charley

BEGIN with Phase 1 (Reconnaissance) and proceed through all 11 MITRE phases systematically.
Test EVERY vulnerability module in DVWA." \
  --max-iterations "$MAX_ITERATIONS"

echo ""
echo "================================================================================"
echo "âœ… PENTEST COMPLETED"
echo "================================================================================"
echo "ðŸ“„ Logs saved to: ./logs/"
echo "ðŸ“„ LLM interactions: ./logs/llm_interactions.jsonl"
echo "ðŸ“„ Agent executions: ./logs/agent_executions.jsonl"
echo "ðŸ“„ Full report: ./logs/agent_report_*.json"
echo "ðŸ“„ Dynamic agent log: ./logs/dynamic_agent.log"
echo ""
echo "ðŸ’¡ To analyze results:"
echo "   cat logs/agent_report_*.json | jq '.summary'"
echo "   tail -100 logs/dynamic_agent.log"
echo "================================================================================"
