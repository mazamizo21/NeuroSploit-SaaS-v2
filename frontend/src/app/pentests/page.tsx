"use client";
import { useEffect, useRef, useState } from "react";
import Link from "next/link";
import AppShell from "../AppShell";
import { api, clearToken } from "@/lib/api";
import { Card, Badge } from "@/components/Card";
import { statusColor, formatDate } from "@/lib/utils";
import { Plus, RefreshCw, Crosshair } from "lucide-react";
import { getProviderLabel } from "@/lib/llmProviders";

export default function PentestsPage() {
  return (
    <AppShell>
      <PentestsInner />
    </AppShell>
  );
}

function PentestsInner() {
  const [jobs, setJobs] = useState<any>({ jobs: [], total: 0 });
  const [showCreate, setShowCreate] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const pollRef = useRef<number | null>(null);
  const pollInFlightRef = useRef(false);

  function loadJobs(opts: { background?: boolean; silent?: boolean } = {}) {
    const { background = false, silent = false } = opts;
    if (!background) setLoading(true);
    if (!silent) setError("");
    return api
      .get("/api/v1/jobs?page_size=50")
      .then(setJobs)
      .catch((err) => {
        if (silent) return;
        const msg = err?.message || "Failed to load jobs";
        setError(msg);
      })
      .finally(() => {
        if (!background) setLoading(false);
      });
  }

  useEffect(() => {
    loadJobs();
  }, []);

  const hasActiveJobs = (jobs.jobs || []).some((j: any) =>
    ["pending", "queued", "running"].includes(String(j?.status || "")),
  );

  // Keep the list "live" while jobs are active so users actually see running state.
  useEffect(() => {
    if (!hasActiveJobs) {
      if (pollRef.current) {
        clearInterval(pollRef.current);
        pollRef.current = null;
      }
      return;
    }
    if (pollRef.current) return;
    pollRef.current = window.setInterval(() => {
      if (pollInFlightRef.current) return;
      pollInFlightRef.current = true;
      loadJobs({ background: true, silent: true }).finally(() => {
        pollInFlightRef.current = false;
      });
    }, 5000);
    return () => {
      if (pollRef.current) {
        clearInterval(pollRef.current);
        pollRef.current = null;
      }
    };
  }, [hasActiveJobs]);

  return (
    <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <h1 className="text-2xl font-bold">Pentests</h1>
            {hasActiveJobs && (
              <Badge className="bg-green-500/20 text-green-400 border border-green-500/30">LIVE</Badge>
            )}
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => loadJobs()}
              className="px-3 py-2 rounded-lg bg-[var(--surface2)] border border-[var(--border)] hover:bg-white/5 transition"
            >
              <RefreshCw className="w-4 h-4" />
            </button>
            <button
              onClick={() => setShowCreate(true)}
              className="flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition text-sm font-medium"
            >
              <Plus className="w-4 h-4" /> New Pentest
            </button>
          </div>
        </div>

        {showCreate && <CreateJobForm onCreated={() => { setShowCreate(false); loadJobs(); }} onCancel={() => setShowCreate(false)} />}

        {error && (
          <Card className="border-red-500/40 bg-red-500/5">
            <div className="flex items-center justify-between gap-4">
              <div>
                <p className="text-sm font-medium text-red-300">Could not load jobs</p>
                <p className="text-xs text-[var(--text-dim)]">{error}</p>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    clearToken();
                    setError("");
                  }}
                  className="px-3 py-2 rounded-lg bg-[var(--surface2)] border border-[var(--border)] hover:bg-white/5 transition text-sm"
                >
                  Sign In
                </button>
                <button
                  onClick={() => loadJobs()}
                  className="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition text-sm font-medium"
                >
                  Retry
                </button>
              </div>
            </div>
          </Card>
        )}

        {loading ? (
          <p className="text-[var(--text-dim)]">Loading...</p>
        ) : jobs.jobs?.length === 0 ? (
          <Card className="text-center py-12">
            <Crosshair className="w-12 h-12 mx-auto mb-4 text-[var(--text-dim)]" />
            <p className="text-lg">No pentests yet</p>
            <p className="text-sm text-[var(--text-dim)]">Create your first pentest to get started</p>
          </Card>
        ) : (
          <div className="space-y-3">
            {jobs.jobs.map((j: any) => (
              <Link key={j.id} href={`/pentests/${j.id}`}>
                <Card className="hover:border-indigo-500/50 transition cursor-pointer">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="font-medium">{j.name}</h3>
                      <p className="text-sm text-[var(--text-dim)]">
                        {j.phase} &middot; {(j.targets || []).join(", ")} &middot; {formatDate(j.created_at)}
                      </p>
                    </div>
                    <div className="flex items-center gap-4 text-right">
                      <div>
                        <span className={`text-sm font-medium ${statusColor(j.status)}`}>
                          ‚óè {j.status}
                        </span>
                        {j.progress > 0 && j.status === "running" && (
                          <div className="mt-1 w-24 h-1.5 rounded bg-[var(--surface2)]">
                            <div className="h-full rounded bg-indigo-500" style={{ width: `${j.progress}%` }} />
                          </div>
                        )}
                      </div>
                      <div className="text-right">
                        <p className="text-lg font-bold">{j.findings_count}</p>
                        <p className="text-xs text-[var(--text-dim)]">findings</p>
                      </div>
                      {j.critical_count > 0 && (
                        <Badge className="bg-red-500/20 text-red-400">{j.critical_count} Critical</Badge>
                      )}
                    </div>
                  </div>
                </Card>
              </Link>
            ))}
          </div>
        )}
    </div>
  );
}

function CreateJobForm({ onCreated, onCancel }: { onCreated: () => void; onCancel: () => void }) {
  const [form, setForm] = useState({
    name: "",
    phase: "RECON",
    targets: "",
    scope_id: "c0000000-0000-0000-0000-000000000001",
    intensity: "medium",
    timeout_seconds: 3600,
    target_type: "lab" as "lab" | "external",
    external_target: "",
    authorization_confirmed: false,
    exploit_mode: "explicit_only" as "disabled" | "explicit_only" | "autonomous",
    max_iterations: 2000,
    llm_provider: "",
    supervisor_enabled: null as boolean | null,
    supervisor_provider: "",
    allow_persistence: false,
    allow_defense_evasion: false,
    allow_scope_expansion: true,
    enable_session_handoff: true,
    enable_target_rotation: true,
    target_focus_window: 6,
    target_focus_limit: 30,
    target_min_commands: 8,
  });
  const exploitModeTouched = useRef(false);
  const intensityTouched = useRef(false);
  const timeoutTouched = useRef(false);
  const scopeTouched = useRef(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [llmOptions, setLlmOptions] = useState<any>(null);
  const [scopes, setScopes] = useState<any[]>([]);

  function extractHostOrSelf(value: string): string {
    const v = (value || "").trim();
    if (!v) return "";
    try {
      const u = new URL(v.startsWith("http") ? v : `https://${v}`);
      return (u.hostname || v).trim();
    } catch {
      return v;
    }
  }

  function pickPreferredLabScope(scopesList: any[]) {
    const hasAll = (s: any) => {
      const t = s?.targets || [];
      return t.includes("juiceshop") && t.includes("dvwa") && t.includes("webgoat") && t.includes("vuln-api");
    };
    const lower = (s: any) => String(s?.name || "").toLowerCase();
    return (
      scopesList.find((s) => hasAll(s)) ||
      scopesList.find((s) => lower(s).includes("multi") && lower(s).includes("lab")) ||
      scopesList.find((s) => lower(s).includes("lab") && (s?.targets || []).includes("juiceshop") && (s?.targets || []).length >= 4) ||
      scopesList.find((s) => lower(s).includes("lab") && (s?.targets || []).includes("juiceshop")) ||
      scopesList.find((s) => (s?.targets || []).includes("juiceshop") && (s?.targets || []).includes("dvwa")) ||
      scopesList.find((s) => (s?.targets || []).includes("dvwa")) ||
      scopesList[0]
    );
  }

  function pickPreferredExternalScope(scopesList: any[], externalTarget: string) {
    const ext = extractHostOrSelf(externalTarget).toLowerCase();
    const containsExt = (s: any) =>
      !ext ||
      (s?.targets || []).some((t: any) => {
        const tt = extractHostOrSelf(String(t)).toLowerCase();
        return tt === ext || String(t).toLowerCase() === ext;
      });
    const lower = (s: any) => String(s?.name || "").toLowerCase();
    return (
      (ext ? scopesList.find((s) => containsExt(s) && lower(s).includes("external")) : null) ||
      scopesList.find((s) => lower(s).includes("external")) ||
      (ext ? scopesList.find((s) => containsExt(s)) : null) ||
      scopesList[0]
    );
  }

  function isValidExternalTarget(value: string): boolean {
    // Validate URL
    try {
      new URL(value.startsWith("http") ? value : `https://${value}`);
      return true;
    } catch {}
    // Validate IP (v4)
    const ipv4 = /^(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?$/;
    if (ipv4.test(value)) {
      const parts = value.split("/")[0].split(".");
      return parts.every((p) => parseInt(p) >= 0 && parseInt(p) <= 255);
    }
    // Validate hostname
    const hostname = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z]{2,})+$/;
    return hostname.test(value);
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setLoading(true);
    setError("");

    if (form.exploit_mode === "disabled" && (form.phase === "EXPLOIT" || form.phase === "POST_EXPLOIT" || form.phase === "LATERAL" || form.phase === "FULL")) {
      setError("Exploit mode is disabled. Choose a non-exploit phase or enable exploitation.");
      setLoading(false);
      return;
    }

    if (form.target_type === "external") {
      if (!form.external_target.trim()) {
        setError("External target URL or IP is required");
        setLoading(false);
        return;
      }
      if (!isValidExternalTarget(form.external_target.trim())) {
        setError("Invalid URL, IP address, or hostname");
        setLoading(false);
        return;
      }
      if (!form.authorization_confirmed) {
        setError("You must confirm authorization to test this target");
        setLoading(false);
        return;
      }
    }

    try {
      const targets =
        form.target_type === "external"
          ? [form.external_target.trim()]
          : form.targets.split(",").map((t) => t.trim()).filter(Boolean);

      await api.post("/api/v1/jobs", {
        name: form.name,
        phase: form.phase,
        targets,
        scope_id: form.scope_id,
        intensity: form.intensity,
        timeout_seconds: form.timeout_seconds,
        target_type: form.target_type,
        authorization_confirmed: form.authorization_confirmed,
        exploit_mode: form.exploit_mode,
        max_iterations: form.max_iterations,
        llm_provider: form.llm_provider || undefined,
        supervisor_enabled: form.supervisor_enabled,
        supervisor_provider: form.supervisor_provider || undefined,
        allow_persistence: form.allow_persistence,
        allow_defense_evasion: form.allow_defense_evasion,
        allow_scope_expansion: form.allow_scope_expansion,
        enable_session_handoff: form.enable_session_handoff,
        enable_target_rotation: form.enable_target_rotation,
        target_focus_window: form.target_focus_window,
        target_focus_limit: form.target_focus_limit,
        target_min_commands: form.target_min_commands,
      });
      onCreated();
    } catch (err: any) {
      setError(err.message || "Failed to create job");
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    api.get("/api/v1/settings/exploit-mode")
      .then((res) => {
        if (exploitModeTouched.current) return;
        if (res?.exploit_mode) {
          setForm((prev) => ({ ...prev, exploit_mode: res.exploit_mode }));
        }
      })
      .catch(() => {});
    api.get("/api/v1/settings/job-defaults")
      .then((res) => {
        setForm((prev) => {
          const next = { ...prev };
          if (!intensityTouched.current && res?.default_intensity) {
            next.intensity = res.default_intensity;
          }
          if (!timeoutTouched.current && res?.default_timeout_seconds) {
            next.timeout_seconds = res.default_timeout_seconds;
          }
          return next;
        });
      })
      .catch(() => {});
    api.get("/api/v1/settings/llm/options")
      .then(setLlmOptions)
      .catch(() => {});
    api
      .get("/api/v1/scopes")
      .then((list: any) => {
        const scopesList = Array.isArray(list) ? list : [];
        setScopes(scopesList);
        if (scopeTouched.current || scopesList.length === 0) return;
        // Prefer a broad lab scope when available so users can target common lab services.
        const preferred = pickPreferredLabScope(scopesList);
        if (preferred?.id) {
          setForm((prev) => (prev.scope_id === preferred.id ? prev : { ...prev, scope_id: preferred.id }));
        }
      })
      .catch(() => {});
  }, []);

  const inputCls = "w-full px-3 py-2 rounded-lg bg-[var(--surface2)] border border-[var(--border)] text-white text-sm";
  const selectedScope = scopes.find((s: any) => s?.id === form.scope_id);
  const selectedScopeTargets: string[] = (selectedScope?.targets || []).map((t: any) => String(t));
  const targetsToCheck =
    form.target_type === "external"
      ? (form.external_target.trim() ? [form.external_target.trim()] : [])
      : form.targets.split(",").map((t) => t.trim()).filter(Boolean);
  const outOfScope = targetsToCheck.filter((t) => {
    if (!selectedScopeTargets.length) return false;
    const candidate = extractHostOrSelf(t).toLowerCase();
    return !selectedScopeTargets.some((st) => extractHostOrSelf(String(st)).toLowerCase() === candidate || String(st).toLowerCase() === candidate);
  });

  return (
    <Card>
      <h3 className="text-lg font-medium mb-4">Create New Pentest</h3>
      {error && <p className="text-red-400 text-sm mb-2">{error}</p>}
      {error.toLowerCase().includes("not within approved scope") && (
        <p className="text-amber-400 text-xs mb-3">
          Tip: Choose a scope that includes your target, or switch to External URL/IP for non-lab hosts.
        </p>
      )}
      {selectedScopeTargets.length > 0 && outOfScope.length > 0 && (
        <p className="text-amber-400 text-xs mb-3">
          Warning: {outOfScope.join(", ")} not in selected scope <code className="px-1 py-0.5 rounded bg-black/30">{selectedScope?.name}</code>. Choose a different scope or adjust targets.
        </p>
      )}
      <form onSubmit={handleSubmit} className="grid grid-cols-2 gap-4">
        <div>
          <label className="text-xs text-[var(--text-dim)]">Name</label>
          <input className={inputCls} value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })} required />
        </div>
        <div>
          <label className="text-xs text-[var(--text-dim)]">Phase</label>
          <select className={inputCls} value={form.phase} onChange={(e) => setForm({ ...form, phase: e.target.value })}>
            {[
              { value: "RECON", label: "RECON" },
              { value: "VULN_SCAN", label: "VULN_SCAN" },
              { value: "EXPLOIT", label: "EXPLOIT" },
              { value: "POST_EXPLOIT", label: "POST_EXPLOIT" },
              { value: "LATERAL", label: "LATERAL (Post-Exploit)" },
              { value: "FULL", label: "FULL (Autonomous)" },
              { value: "REPORT", label: "REPORT" },
            ].map((p) => (
              <option key={p.value} value={p.value}>{p.label}</option>
            ))}
          </select>
        </div>
        <div className="col-span-2">
          <label className="text-xs text-[var(--text-dim)]">LLM Provider Override</label>
          <select
            className={inputCls}
            value={form.llm_provider}
            onChange={(e) => setForm({ ...form, llm_provider: e.target.value })}
          >
            <option value="">Use global default</option>
            {(llmOptions?.enabled_providers || []).map((providerId: string) => (
              <option key={providerId} value={providerId}>
                {getProviderLabel(providerId)}
              </option>
            ))}
          </select>
          <p className="text-xs text-[var(--text-dim)] mt-1">
            Global default: {llmOptions?.default_provider ? getProviderLabel(llmOptions.default_provider) : "env default"}
          </p>
        </div>

        {/* Supervisor Override */}
        <div className="col-span-2 rounded-lg border border-[var(--border)] bg-[var(--surface2)] p-3">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-semibold text-slate-200">Supervisor</p>
              <p className="text-[11px] text-[var(--text-dim)]">
                LLM supervisor monitors job progress and intervenes on stalls.
                {llmOptions?.supervisor_enabled != null && (
                  <span> Global default: <strong>{llmOptions.supervisor_enabled ? "Enabled" : "Disabled"}</strong></span>
                )}
              </p>
            </div>
            <div className="flex items-center gap-2">
              <select
                className="px-2 py-1 rounded bg-[var(--surface2)] border border-[var(--border)] text-white text-xs"
                value={form.supervisor_enabled === null ? "" : form.supervisor_enabled ? "on" : "off"}
                onChange={(e) => {
                  const v = e.target.value;
                  setForm({ ...form, supervisor_enabled: v === "" ? null : v === "on" });
                }}
              >
                <option value="">Use global default</option>
                <option value="on">Enabled</option>
                <option value="off">Disabled</option>
              </select>
            </div>
          </div>
          {(form.supervisor_enabled === true || (form.supervisor_enabled === null && llmOptions?.supervisor_enabled)) && (
            <div className="mt-3">
              <label className="text-[11px] text-[var(--text-dim)]">Supervisor LLM Provider</label>
              <select
                className="w-full px-3 py-2 rounded-lg bg-[var(--surface2)] border border-[var(--border)] text-white text-sm mt-1"
                value={form.supervisor_provider}
                onChange={(e) => setForm({ ...form, supervisor_provider: e.target.value })}
              >
                <option value="">Use global default{llmOptions?.supervisor_provider ? ` (${getProviderLabel(llmOptions.supervisor_provider)})` : ""}</option>
                {(llmOptions?.enabled_providers || []).map((providerId: string) => (
                  <option key={providerId} value={providerId}>
                    {getProviderLabel(providerId)}
                  </option>
                ))}
              </select>
            </div>
          )}
        </div>

        <div className="col-span-2">
          <label className="text-xs text-[var(--text-dim)]">Exploit Mode</label>
          <select
            className={inputCls}
            value={form.exploit_mode}
            onChange={(e) => {
              exploitModeTouched.current = true;
              setForm({ ...form, exploit_mode: e.target.value as "disabled" | "explicit_only" | "autonomous" });
            }}
          >
            <option value="explicit_only">Explicit Only (Recommended)</option>
            <option value="autonomous">Autonomous (Allow Exploit)</option>
            <option value="disabled">Disabled (No Exploit)</option>
          </select>
          <p className="text-xs text-[var(--text-dim)] mt-1">
            Controls whether exploitation/post-exploitation actions are allowed. External targets still require written authorization.
          </p>
        </div>

        <div className="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3">
          <label className="flex items-start gap-2 text-xs text-[var(--text-dim)]">
            <input
              type="checkbox"
              checked={form.allow_scope_expansion}
              onChange={(e) => setForm({ ...form, allow_scope_expansion: e.target.checked })}
              className="mt-1"
            />
            <span>
              Allow internal scope expansion (lab only)
              <span className="block text-[11px] opacity-70">Enable internal network discovery and lateral movement.</span>
            </span>
          </label>
          <label className="flex items-start gap-2 text-xs text-[var(--text-dim)]">
            <input
              type="checkbox"
              checked={form.enable_session_handoff}
              onChange={(e) => setForm({ ...form, enable_session_handoff: e.target.checked })}
              className="mt-1"
            />
            <span>
              Enable session handoff
              <span className="block text-[11px] opacity-70">Surface interactive shell commands in the GUI.</span>
            </span>
          </label>
          <label className="flex items-start gap-2 text-xs text-[var(--text-dim)]">
            <input
              type="checkbox"
              checked={form.allow_persistence}
              onChange={(e) => setForm({ ...form, allow_persistence: e.target.checked })}
              className="mt-1"
            />
            <span>
              Allow persistence (lab only)
              <span className="block text-[11px] opacity-70">Enable persistence actions after access.</span>
            </span>
          </label>
          <label className="flex items-start gap-2 text-xs text-[var(--text-dim)]">
            <input
              type="checkbox"
              checked={form.allow_defense_evasion}
              onChange={(e) => setForm({ ...form, allow_defense_evasion: e.target.checked })}
              className="mt-1"
            />
            <span>
              Allow cleanup/defense evasion (lab only)
              <span className="block text-[11px] opacity-70">Enable log clearing and artifact cleanup.</span>
            </span>
          </label>
        </div>

        <div className="col-span-2 rounded-lg border border-[var(--border)] bg-[var(--surface2)] p-3">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-semibold text-slate-200">Target Rotation</p>
              <p className="text-[11px] text-[var(--text-dim)]">
                Prevent tunnel vision by auto-pivoting after too many actions on one target.
              </p>
            </div>
            <label className="flex items-center gap-2 text-xs text-[var(--text-dim)]">
              <input
                type="checkbox"
                checked={form.enable_target_rotation}
                onChange={(e) => setForm({ ...form, enable_target_rotation: e.target.checked })}
                className="mt-0.5"
              />
              Enable
            </label>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
            <div>
              <label className="text-[11px] text-[var(--text-dim)]">Focus Window</label>
              <input
                type="number"
                min={2}
                max={50}
                className={inputCls}
                disabled={!form.enable_target_rotation}
                value={form.target_focus_window}
                onChange={(e) => {
                  const val = Math.max(2, Math.min(50, Number(e.target.value) || 2));
                  setForm({ ...form, target_focus_window: val });
                }}
              />
            </div>
            <div>
              <label className="text-[11px] text-[var(--text-dim)]">Max Actions/Target</label>
              <input
                type="number"
                min={5}
                max={5000}
                className={inputCls}
                disabled={!form.enable_target_rotation}
                value={form.target_focus_limit}
                onChange={(e) => {
                  const val = Math.max(5, Math.min(5000, Number(e.target.value) || 5));
                  setForm({ ...form, target_focus_limit: val });
                }}
              />
            </div>
            <div>
              <label className="text-[11px] text-[var(--text-dim)]">Min Actions Before Pivot</label>
              <input
                type="number"
                min={1}
                max={500}
                className={inputCls}
                disabled={!form.enable_target_rotation}
                value={form.target_min_commands}
                onChange={(e) => {
                  const val = Math.max(1, Math.min(500, Number(e.target.value) || 1));
                  setForm({ ...form, target_min_commands: val });
                }}
              />
            </div>
          </div>
        </div>

        {/* Target Type Selector */}
        <div className="col-span-2">
          <label className="text-xs text-[var(--text-dim)] mb-2 block">Target Type</label>
          <div className="flex gap-3">
            <button
              type="button"
              onClick={() =>
                setForm((prev) => {
                  const next = {
                    ...prev,
                    target_type: "lab" as const,
                    allow_scope_expansion: prev.allow_scope_expansion ?? true,
                    enable_session_handoff: prev.enable_session_handoff ?? true,
                  };
                  if (!scopeTouched.current && scopes.length > 0) {
                    const labScope = pickPreferredLabScope(scopes);
                    if (labScope?.id) next.scope_id = labScope.id;
                  }
                  // If user entered a simple lab hostname in the external field, carry it over.
                  const ext = (prev.external_target || "").trim();
                  if (!prev.targets.trim() && ext && /^[a-zA-Z0-9-]+$/.test(ext)) {
                    next.targets = ext;
                  }
                  return next;
                })
              }
              className={`flex-1 px-4 py-3 rounded-lg border text-sm font-medium transition ${
                form.target_type === "lab"
                  ? "border-indigo-500 bg-indigo-500/10 text-indigo-400"
                  : "border-[var(--border)] bg-[var(--surface2)] text-[var(--text-dim)] hover:bg-white/5"
              }`}
            >
              üî¨ Lab Target
              <span className="block text-xs mt-1 font-normal opacity-70">Docker lab containers (DVWA, JuiceShop, etc.)</span>
            </button>
            <button
              type="button"
              onClick={() =>
                setForm((prev) => {
                  const next = {
                    ...prev,
                    target_type: "external" as const,
                    allow_scope_expansion: false,
                    allow_persistence: false,
                    allow_defense_evasion: false,
                    enable_session_handoff: false,
                  };
                  // Convenience: if a single target was entered in lab mode, carry it over.
                  if (!prev.external_target.trim()) {
                    const parts = prev.targets.split(",").map((t) => t.trim()).filter(Boolean);
                    if (parts.length === 1) next.external_target = parts[0];
                  }
                  if (!scopeTouched.current && scopes.length > 0) {
                    const externalScope = pickPreferredExternalScope(scopes, next.external_target);
                    if (externalScope?.id) next.scope_id = externalScope.id;
                  }
                  return next;
                })
              }
              className={`flex-1 px-4 py-3 rounded-lg border text-sm font-medium transition ${
                form.target_type === "external"
                  ? "border-indigo-500 bg-indigo-500/10 text-indigo-400"
                  : "border-[var(--border)] bg-[var(--surface2)] text-[var(--text-dim)] hover:bg-white/5"
              }`}
            >
              üåê External URL/IP
              <span className="block text-xs mt-1 font-normal opacity-70">Internet-facing target you have authorization to test</span>
            </button>
          </div>
        </div>

        <div className="col-span-2">
          <label className="text-xs text-[var(--text-dim)]">Scope</label>
          <select
            className={inputCls}
            value={form.scope_id}
            onChange={(e) => {
              scopeTouched.current = true;
              setForm({ ...form, scope_id: e.target.value });
            }}
          >
            {scopes.length === 0 ? (
              <option value={form.scope_id}>Default scope</option>
            ) : (
              scopes.map((s: any) => (
                <option key={s.id} value={s.id}>
                  {s.name} ({(s.targets || []).length} targets)
                </option>
              ))
            )}
          </select>
          <p className="text-xs text-[var(--text-dim)] mt-1">
            Targets must be inside the selected scope.
            {form.target_type === "external" ? " For external targets, pick a scope you have authorization for." : ""}
          </p>
          {selectedScopeTargets.length > 0 && (
            <p className="text-[11px] text-[var(--text-dim)] mt-1">
              Includes: {selectedScopeTargets.slice(0, 6).join(", ")}
              {selectedScopeTargets.length > 6 ? ` (+${selectedScopeTargets.length - 6} more)` : ""}
            </p>
          )}
        </div>

        {form.target_type === "lab" ? (
          <div>
            <label className="text-xs text-[var(--text-dim)]">Targets (comma-separated)</label>
            <input
              className={inputCls}
              value={form.targets}
              onChange={(e) => setForm({ ...form, targets: e.target.value })}
              placeholder="juiceshop, dvwa, webgoat, vuln-api"
              required
            />
          </div>
        ) : (
          <>
            <div className="col-span-2">
              <label className="text-xs text-[var(--text-dim)]">External Target URL or IP</label>
              <input
                className={inputCls}
                value={form.external_target}
                onChange={(e) => setForm({ ...form, external_target: e.target.value })}
                placeholder="scanme.nmap.org, https://example.com, 203.0.113.1"
                required
              />
              <p className="text-xs text-[var(--text-dim)] mt-1">Enter a URL, hostname, or IP address</p>
            </div>
            <div className="col-span-2">
              <label className="flex items-start gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  checked={form.authorization_confirmed}
                  onChange={(e) => setForm({ ...form, authorization_confirmed: e.target.checked })}
                  className="mt-1 rounded border-[var(--border)] bg-[var(--surface2)]"
                />
                <span className="text-sm text-amber-400">
                  ‚ö†Ô∏è I confirm I have written authorization to perform security testing on this target.
                  Unauthorized testing is illegal.
                </span>
              </label>
            </div>
          </>
        )}

        <div>
          <label className="text-xs text-[var(--text-dim)]">Intensity</label>
          <select
            className={inputCls}
            value={form.intensity}
            onChange={(e) => {
              intensityTouched.current = true;
              setForm({ ...form, intensity: e.target.value });
            }}
          >
            {["low", "medium", "high"].map((i) => (
              <option key={i} value={i}>{i}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="text-xs text-[var(--text-dim)]">Timeout (minutes)</label>
          <input
            type="number"
            min={1}
            max={240}
            step={1}
            className={inputCls}
            value={Math.max(1, Math.round(form.timeout_seconds / 60))}
            onChange={(e) => {
              timeoutTouched.current = true;
              const minutes = Math.max(1, Math.min(240, Number(e.target.value)));
              setForm({ ...form, timeout_seconds: minutes * 60 });
            }}
          />
        </div>

        {/* Max Iterations */}
        <div className="col-span-2">
          <div className="flex items-center gap-2 mb-2">
            <label className="text-xs text-[var(--text-dim)]">Max Iterations</label>
            {form.max_iterations === 0 ? (
              <span className="text-xs text-amber-400 font-bold">‚àû Unlimited</span>
            ) : (
              <input
                type="number"
                min={5}
                max={99999}
                value={form.max_iterations}
                onChange={(e) => {
                  const val = parseInt(e.target.value) || 5;
                  setForm({ ...form, max_iterations: Math.max(5, Math.min(99999, val)) });
                }}
                className="w-24 px-2 py-0.5 rounded bg-[var(--surface2)] border border-[var(--border)] text-indigo-400 font-mono font-bold text-xs text-center"
              />
            )}
            <span className="text-[10px] text-[var(--text-dim)] ml-auto">
              üí° More iterations = deeper testing but longer runtime &amp; higher cost
            </span>
          </div>
          <div className="flex gap-2">
            {[
              { label: "Quick (10)", value: 10 },
              { label: "Standard (30)", value: 30 },
              { label: "Deep (100)", value: 100 },
              { label: "Full (500)", value: 500 },
              { label: "1000", value: 1000 },
              { label: "2000", value: 2000 },
              { label: "5000", value: 5000 },
              { label: "10000", value: 10000 },
              { label: "‚àû Unlimited", value: 0 },
            ].map((preset) => (
              <button
                key={preset.value}
                type="button"
                onClick={() => setForm({ ...form, max_iterations: preset.value })}
                className={`flex-1 px-2 py-1.5 rounded text-[11px] font-medium transition border ${
                  form.max_iterations === preset.value
                    ? "border-indigo-500 bg-indigo-500/20 text-indigo-300"
                    : preset.value === 0 && form.max_iterations === 0
                    ? "border-amber-500 bg-amber-500/20 text-amber-300"
                    : "border-[var(--border)] bg-[var(--surface2)] text-[var(--text-dim)] hover:bg-white/5"
                }`}
              >
                {preset.label}
              </button>
            ))}
          </div>
        </div>

        <div className="col-span-2 flex gap-2 justify-end">
          <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg bg-[var(--surface2)] text-sm">
            Cancel
          </button>
          <button type="submit" disabled={loading} className="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-medium disabled:opacity-50">
            {loading ? "Creating..." : "Create Pentest"}
          </button>
        </div>
      </form>
    </Card>
  );
}
