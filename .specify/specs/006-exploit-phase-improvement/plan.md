# Implementation Plan: Exploit Phase Improvement

**Branch**: `006-exploit-phase-improvement` | **Date**: 2026-02-08 | **Spec**: spec.md

## Summary

Fix the Dynamic Agent's exploit phase by: (1) ensuring sqlmap always runs in batch/non-interactive mode, (2) building a fallback exploit strategy so failures lead to alternative exploits instead of enumeration, (3) deduplicating target aliases, and (4) making exploit gate prompts tactically useful.

## Technical Context

**Language/Version**: Python 3.11+  
**Primary File**: `kali-executor/open-interpreter/dynamic_agent.py` (~4300 lines)  
**Testing**: Manual E2E via Docker Compose job execution against Juice Shop lab target  
**Target Platform**: Kali Linux containers (Docker)  
**Constraints**: Changes must be backward-compatible with existing jobs, no new dependencies

## Constitution Check

- ✅ Evidence-First Exploitation — enhances, does not weaken the proof gate
- ✅ No Hardcoded Exploits — exploit templates are guidance, not hardcoded paths
- ✅ Separation of Concerns — changes are limited to Kali Plane (Dynamic Agent)
- ✅ Supervisor Independence — supervisor is not modified

## Changes Required

All changes are in `kali-executor/open-interpreter/dynamic_agent.py`:

### 1. sqlmap Command Sanitizer (FR-001, FR-002)
- Add `_sanitize_sqlmap_command()` method
- Intercept sqlmap commands before execution
- Inject `--batch` if missing
- Inject `--timeout=120` if no timeout specified
- Add `--level 2 --risk 2` for better detection if not specified

### 2. Exploit Fallback Strategy (FR-003, FR-004)
- Enhance `_get_exploit_push_message()` with vuln-type-specific templates
- Add `_get_exploit_templates_for_vuln()` method returning concrete commands per vuln type
- Track exploit technique diversity per vuln in `vulns_found` dict
- Require ≥3 different technique categories before marking not-exploitable

### 3. Target Alias Deduplication (FR-005)
- Add `_normalize_target_alias()` method  
- Maintain a `target_aliases` dict mapping discovered IPs to known hostnames
- Check before running recon if this target was already scanned under a different name
- Inject a user message when alias detected: "Target X is the same as Y — skip recon"

### 4. Exploit Gate Enrichment (FR-003)
- Modify the exploit gate reprompt in the main loop
- Include: vuln type, target, what's been tried, suggested next commands
- Pull from `_get_exploit_templates_for_vuln()` for concrete suggestions

### 5. Context Preservation (FR-006)
- Modify `_truncate_conversation()` to preserve exploit attempt messages
- Tag exploit-related messages so they survive trimming
- Keep last 3 exploit attempts in context even during aggressive trimming

## Project Structure

```text
kali-executor/open-interpreter/
├── dynamic_agent.py          # ALL changes go here
└── tests/
    └── test_exploit_phase.py  # New: validate sqlmap sanitization, template generation
```

## Risk Assessment

| Risk | Mitigation |
|------|-----------|
| sqlmap --batch may miss interactive-only vulns | Add `--forms` flag for form-based testing |
| Exploit templates may not fit all targets | Templates are suggestions, not forced commands |
| Target alias detection false positives | Only deduplicate when confirmed by HTTP response |
| Context preservation may bloat conversation | Cap preserved exploit messages at 3 |
