# Feature Specification: Exploit Phase Improvement

**Feature Branch**: `006-exploit-phase-improvement`  
**Created**: 2026-02-08  
**Status**: Active  
**Input**: Live observation of job 16d7b9af running against Juice Shop — agent fails to transition from recon to effective exploitation

## Problem Statement

The Dynamic Agent consistently fails to effectively exploit discovered vulnerabilities. From live monitoring of multiple runs:

1. **sqlmap gets killed** — Agent runs sqlmap without `--batch` flag, causing it to hang waiting for user input → subprocess timeout kills it (exit -1)
2. **Agent re-enumerates after failed exploit** — When sqlmap fails, agent falls back to downloading more /ftp/ files instead of trying alternative exploit techniques
3. **LLM response times 5-62 seconds** — The ZAI/GLM model is extremely slow, with some responses taking 62 seconds, causing each iteration to crawl
4. **Hostname/IP duplication** — Agent discovers the target's IP address, then re-runs all recon against the IP that it already did against the hostname
5. **Exploit gate blocks but doesn't guide** — The exploit gate correctly blocks enum commands after vulns are found, but the reprompt message doesn't give enough tactical context about WHAT to exploit
6. **Context trimming loses exploit history** — Conversation is trimmed to ~20K chars, losing critical exploit context and making the agent "forget" what it already tried

## User Scenarios & Testing

### User Story 1 - sqlmap Runs Successfully (Priority: P1)

When the Dynamic Agent decides to run sqlmap against a target, it should always use `--batch` mode and appropriate timeouts so it never hangs waiting for interactive input.

**Why this priority**: sqlmap hanging is the #1 reason exploit attempts fail — it blocks the entire iteration pipeline

**Independent Test**: Start a job against Juice Shop, observe sqlmap commands include `--batch` flag and complete within the command timeout

**Acceptance Scenarios**:

1. **Given** agent decides to run sqlmap, **When** the command is constructed, **Then** `--batch` flag is always injected if missing
2. **Given** sqlmap is running against a target, **When** the command timeout is reached, **Then** the agent gets useful partial output (not just exit -1)
3. **Given** sqlmap finds an injectable parameter, **When** it runs `--dump`, **Then** the proof gate accepts the output as valid evidence

---

### User Story 2 - Exploit Fallback Strategy (Priority: P1)

When an exploit attempt fails, the agent should try alternative exploitation techniques against the same vulnerability instead of falling back to enumeration.

**Why this priority**: This is the core exploitation loop problem — failure should lead to different exploit, not more scanning

**Independent Test**: Observe agent try sqlmap → fail → try manual SQLi via curl → fail → try different injection point, NOT go back to nmap/gobuster

**Acceptance Scenarios**:

1. **Given** sqlmap fails on /rest/user/login, **When** agent plans next action, **Then** it tries manual SQLi curl payloads against the same endpoint
2. **Given** manual SQLi also fails, **When** agent plans next action, **Then** it tries a different attack vector (XSS, LFI, IDOR) instead of re-enumerating
3. **Given** agent is in exploit mode, **When** a vulnerability is tracked, **Then** the exploit push message includes specific command templates for that vuln type

---

### User Story 3 - Target Deduplication (Priority: P2)

The agent should recognize that `juiceshop`, `172.21.0.12`, and `ns-juiceshop` are the same target and not re-enumerate each alias.

**Why this priority**: Wasted iterations on duplicate recon is a significant time sink

**Independent Test**: Agent discovers target IP, does NOT re-run nmap/gobuster against it, continues exploitation

**Acceptance Scenarios**:

1. **Given** agent has scanned juiceshop:3000, **When** it discovers 172.21.0.12 resolves to the same host, **Then** it skips duplicate scans
2. **Given** agent has findings for "juiceshop", **When** it encounters the IP, **Then** findings are associated with the same target

---

### User Story 4 - Smarter Exploit Gate Prompts (Priority: P2)

The exploit gate reprompt messages should include tactical context: what vulns are tracked, what's been tried, and specific command templates.

**Why this priority**: Current reprompt says "provide ONE exploitation command" but doesn't tell the agent WHAT vulnerability to exploit or HOW

**Independent Test**: Observe exploit gate reprompt includes vuln type, target, and example commands

**Acceptance Scenarios**:

1. **Given** agent has tracked SQLi at juiceshop login, **When** exploit gate fires, **Then** the reprompt says "SQLi found at /rest/user/login — try: sqlmap --batch --dump, or curl with ' OR 1=1-- payload"
2. **Given** agent has 3 unproven vulns, **When** exploit gate fires, **Then** it picks the highest-priority one and gives specific exploit templates

---

### Edge Cases

- What happens when sqlmap output is too large for the context window?
- How does the agent handle when ALL exploit attempts fail for a vuln?
- What if the LLM provider is too slow (>30s) consistently?

## Requirements

### Functional Requirements

- **FR-001**: System MUST inject `--batch` into sqlmap commands that lack it
- **FR-002**: System MUST inject `--timeout` into sqlmap commands to prevent hangs
- **FR-003**: Exploit push messages MUST include vuln-type-specific command templates
- **FR-004**: Agent MUST try at least 3 different exploit techniques before marking a vuln as not-exploitable
- **FR-005**: Agent MUST recognize hostname/IP aliases as the same target
- **FR-006**: Context trimming MUST preserve recent exploit attempts and tracked vuln state
- **FR-007**: System MUST log exploit transition decisions for debugging

## Success Criteria

### Measurable Outcomes

- **SC-001**: sqlmap commands never exit with -1 (hung/killed) — always complete with useful output
- **SC-002**: Agent achieves ≥3 proven exploits per Juice Shop run (vs 0-1 in baseline)
- **SC-003**: No duplicate recon runs against hostname/IP aliases of same target
- **SC-004**: Exploit phase starts within 20 iterations of finding first vuln
- **SC-005**: Agent tries ≥2 different exploit techniques per tracked vulnerability before giving up
