# Tasks: Exploit Phase Improvement

**Input**: spec.md + plan.md  
**Target File**: `kali-executor/open-interpreter/dynamic_agent.py`

## Phase 1: sqlmap Command Sanitizer (P1 — MVP)

- [ ] T001 [US1] Add `_sanitize_sqlmap_command(cmd)` method that:
  - Injects `--batch` if not present
  - Injects `--timeout=120` if no `--timeout` specified
  - Injects `--level 2 --risk 2` if neither `--level` nor `--risk` specified
  - Injects `--output-dir=/pentest/output/<job_id>/sqlmap/` for persistent results
  - Returns sanitized command string

- [ ] T002 [US1] Hook `_sanitize_sqlmap_command()` into command execution pipeline:
  - In the execution section of main loop, before running any command
  - Check if command starts with `sqlmap` → apply sanitizer
  - Log the sanitization: "SQLMAP SANITIZED: added --batch --timeout=120"

- [ ] T003 [US1] Test: Run job, verify sqlmap commands include `--batch`, complete with exit=0 not exit=-1

**Checkpoint**: sqlmap never hangs again

## Phase 2: Exploit Templates & Enriched Gate Prompts (P1)

- [ ] T004 [US2] Add `_get_exploit_templates_for_vuln(vuln_type, target)` method returning a list of concrete command templates:
  - `sql injection` → sqlmap --batch --dump, manual curl SQLi, auth bypass
  - `xss` → reflected XSS via curl + DOM renderer, stored XSS via API
  - `path traversal` / `lfi` → curl with ../ payloads, null byte injection
  - `information disclosure` → download exposed files, check API endpoints
  - `command injection` → curl with ; and | payloads, commix
  - `idor` → iterate API endpoints with different IDs
  - `mass assignment` → curl with role=admin in JSON body
  - `file upload` → upload webshell, test execution
  - Default → searchsploit + msfconsole + manual curl

- [ ] T005 [US2] Modify `_get_exploit_push_message()` to include:
  - The specific vuln type and target being focused
  - What commands have already been tried (from vuln.attempts)
  - 2-3 concrete command templates from `_get_exploit_templates_for_vuln()`
  - "DO NOT repeat: [list of tried approaches]"

- [ ] T006 [US4] Modify exploit gate reprompt in main loop:
  - Replace generic "provide ONE exploitation command" with enriched message
  - Include current_vuln_focus_id details
  - Include templates from `_get_exploit_templates_for_vuln()`

- [ ] T007 [US2] Track exploit technique diversity in `_record_vuln_attempt()`:
  - Classify each attempt into technique category (sqlmap, manual_sqli, curl_injection, file_upload, etc.)
  - Store unique technique categories in vuln dict as `techniques_tried`
  - Require ≥3 unique techniques before `not_exploitable` marking

- [ ] T008 [US2] Test: Run job, verify exploit gate messages include specific commands and vuln context

**Checkpoint**: Exploit gate guides the agent with specific, actionable commands

## Phase 3: Target Alias Deduplication (P2)

- [ ] T009 [US3] Add `target_aliases` dict to `__init__` and `_resolve_target_alias(target)` method:
  - Check if a new target resolves to same IP as a known target
  - Maintain mapping: `{"172.21.0.12": "juiceshop", "ns-juiceshop": "juiceshop"}`
  - When nmap/curl discovers an IP for a known hostname, register the alias

- [ ] T010 [US3] Hook alias detection into `_auto_track_vulns_from_execution()`:
  - When a command targets a known alias, normalize to the canonical target name
  - Prevents duplicate vuln entries for same target under different names

- [ ] T011 [US3] Add enum skip for aliased targets:
  - Before executing nmap/gobuster/nikto against a target, check if it's an alias
  - If alias of already-scanned target, inject user message: "⚡ Target X is alias of Y (already scanned). Skip recon and proceed to exploitation."
  - Don't block the command entirely (might have different ports), just warn

- [ ] T012 [US3] Test: Run job, verify agent doesn't re-enumerate the IP after scanning hostname

**Checkpoint**: No wasted iterations on duplicate target scanning

## Phase 4: Polish

- [ ] T013 Verify all changes work together in a full FULL-phase Juice Shop run
- [ ] T014 Document changes in a commit message referencing spec 006
- [ ] T015 Save learnings and test results to memory

## Dependencies

- T001 → T002 → T003 (sequential: build, hook, test)
- T004 → T005, T006 (templates needed before gate enrichment)
- T007 depends on T004 (technique classification)
- T009 → T010 → T011 → T012 (sequential alias pipeline)
- Phase 4 depends on all above
