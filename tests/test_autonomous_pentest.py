#!/usr/bin/env python3
"""
TazoSploit Autonomous Pentest Test Script
Tests the autonomous pentesting capabilities against vulnerable targets.

Usage:
    python3 tests/test_autonomous_pentest.py --target http://localhost:8080 --type dvwa
    python3 tests/test_autonomous_pentest.py --target 10.0.2.5 --network-scan
"""

import sys
import os
import argparse
import json
import time
from datetime import datetime, timezone, UTC
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from orchestrator import AgentOrchestrator, AgentTask
from multi_agent import MultiAgentSession, SessionStatus
from skills.skills_manager import SkillsManager
from schedulers import ScanJob, ReconJob, ExploitJob, JobType


class AutonomousPentestTester:
    """Test autonomous pentesting against vulnerable targets"""

    def __init__(self, target: str, test_type: str = "web"):
        self.target = target
        self.test_type = test_type
        self.skills_manager = SkillsManager()
        self.orchestrator = AgentOrchestrator()
        self.results = {
            "test_id": f"test-{int(time.time())}",
            "target": target,
            "test_type": test_type,
            "started_at": datetime.now(timezone.utc).isoformat(),
            "phases": [],
            "findings": [],
            "errors": [],
            "metrics": {
                "total_time": 0,
                "phases_completed": 0,
                "tools_used": [],
                "findings_count": 0
            }
        }

    def log_phase(self, phase_name: str, status: str, details: str = ""):
        """Log a test phase"""
        phase = {
            "phase": phase_name,
            "status": status,
            "timestamp": datetime.now(timezone.utc).isoformat(),
            "details": details
        }
        self.results["phases"].append(phase)
        print(f"[{phase_name}] {status}: {details}")

    def test_skill_loader(self):
        """Test 1: Skills Manager"""
        self.log_phase("Skills Manager", "STARTED", "Loading all available skills from marketplace")

        try:
            skills = self.skills_manager.list_skills()
            print(f"  ✓ Loaded {len(skills)} skills from marketplace")

            for skill_meta in skills:
                status_icon = "✓" if skill_meta.installed else "○"
                print(f"    {status_icon} {skill_meta.id}: {skill_meta.name} ({skill_meta.category})")

            self.results["metrics"]["skills_loaded"] = len(skills)
            self.log_phase("Skills Manager", "COMPLETED", f"Successfully loaded {len(skills)} skills from marketplace")

        except Exception as e:
            error = f"Skills manager failed: {str(e)}"
            self.log_phase("Skills Manager", "FAILED", error)
            self.results["errors"].append(error)

    def test_scheduler(self):
        """Test 2: Job Scheduler"""
        self.log_phase("Job Scheduler", "STARTED", "Testing job creation and management")

        try:
            from schedulers import CronScheduler
            scheduler = CronScheduler()

            # Create test job
            job_config = ScanJob(
                name="Test Nmap Scan",
                target=self.target,
                scan_type="quick"
            )

            self.log_phase("Job Scheduler", "COMPLETED", "Successfully created test job")

        except Exception as e:
            error = f"Scheduler test failed: {str(e)}"
            self.log_phase("Job Scheduler", "FAILED", error)
            self.results["errors"].append(error)

    def test_reconnaissance(self):
        """Test 3: Reconnaissance Skills"""
        self.log_phase("Reconnaissance", "STARTED", "Checking reconnaissance capabilities")

        try:
            # List reconnaissance skills
            recon_skills = self.skills_manager.search_skills("recon")

            if recon_skills:
                print(f"  ✓ Found {len(recon_skills)} reconnaissance skills:")

                for skill_meta in recon_skills:
                    print(f"    - {skill_meta.name}: {skill_meta.description}")
                    if skill_meta.tools:
                        self.results["metrics"]["tools_used"].extend(skill_meta.tools)

                self.log_phase("Reconnaissance", "COMPLETED", f"Found {len(recon_skills)} reconnaissance skills")

            else:
                raise Exception("No reconnaissance skills found in marketplace")

        except Exception as e:
            error = f"Reconnaissance test failed: {str(e)}"
            self.log_phase("Reconnaissance", "FAILED", error)
            self.results["errors"].append(error)

    def test_multi_agent(self):
        """Test 4: Multi-Agent System"""
        self.log_phase("Multi-Agent System", "STARTED", "Initializing multi-agent session")

        try:
            # Create session
            session = MultiAgentSession(
                session_id=f"test-session-{int(time.time())}",
                target=self.target,
                objective="Autonomous security assessment",
                status=SessionStatus.INITIALIZING,
                created_at=datetime.now(timezone.utc).isoformat(),
                orchestrator=self.orchestrator
            )

            print(f"  ✓ Session created: {session.session_id}")

            # Check agents (access directly since orchestrator doesn't have get_agents method)
            if hasattr(self.orchestrator, 'agents'):
                print(f"  ✓ Available agents: {len(self.orchestrator.agents)}")
                self.results["metrics"]["agents_available"] = len(self.orchestrator.agents)
            else:
                print(f"  ✓ Orchestrator initialized successfully")
                self.results["metrics"]["agents_available"] = 0

            self.log_phase("Multi-Agent System", "COMPLETED", f"Session created successfully")

        except Exception as e:
            error = f"Multi-agent test failed: {str(e)}"
            self.log_phase("Multi-Agent System", "FAILED", error)
            self.results["errors"].append(error)

    def test_vulnerability_scanning(self):
        """Test 5: Vulnerability Scanning Skills"""
        self.log_phase("Vulnerability Scanning", "STARTED", "Checking vulnerability scanning capabilities")

        try:
            # List scanning skills
            scan_skills = self.skills_manager.search_skills("scan")

            if scan_skills:
                print(f"  ✓ Found {len(scan_skills)} scanning skills:")

                for skill_meta in scan_skills:
                    print(f"    - {skill_meta.name}: {skill_meta.description}")
                    if skill_meta.tools:
                        self.results["metrics"]["tools_used"].extend(skill_meta.tools)

                self.log_phase("Vulnerability Scanning", "COMPLETED", f"Found {len(scan_skills)} scanning skills")

            else:
                raise Exception("No scanning skills found in marketplace")

        except Exception as e:
            error = f"Vulnerability scanning test failed: {str(e)}"
            self.log_phase("Vulnerability Scanning", "FAILED", error)
            self.results["errors"].append(error)

    def test_report_generation(self):
        """Test 6: Report Generation Skills"""
        self.log_phase("Report Generation", "STARTED", "Checking report generation capabilities")

        try:
            # List reporting skills
            report_skills = self.skills_manager.search_skills("report")

            if report_skills:
                print(f"  ✓ Found {len(report_skills)} reporting skills:")

                for skill_meta in report_skills:
                    print(f"    - {skill_meta.name}: {skill_meta.description}")
                    if skill_meta.tools:
                        self.results["metrics"]["tools_used"].extend(skill_meta.tools)

                self.log_phase("Report Generation", "COMPLETED", f"Found {len(report_skills)} reporting skills")

            else:
                raise Exception("No reporting skills found in marketplace")

        except Exception as e:
            error = f"Report generation test failed: {str(e)}"
            self.log_phase("Report Generation", "FAILED", error)
            self.results["errors"].append(error)

    def run_all_tests(self):
        """Run all autonomous pentest tests"""
        print("\n" + "="*70)
        print("TAZOSPLOIT AUTONOMOUS PENTEST TEST SUITE")
        print("="*70)
        print(f"Target: {self.target}")
        print(f"Test Type: {self.test_type}")
        print(f"Started: {datetime.now(timezone.utc).isoformat()}")
        print("="*70 + "\n")

        start_time = time.time()

        # Run all test phases
        self.test_skill_loader()
        self.test_scheduler()
        self.test_reconnaissance()
        self.test_multi_agent()
        self.test_vulnerability_scanning()
        self.test_report_generation()

        # Calculate metrics
        end_time = time.time()
        self.results["metrics"]["total_time"] = end_time - start_time
        self.results["metrics"]["phases_completed"] = len([p for p in self.results["phases"] if p["status"] == "COMPLETED"])
        self.results["metrics"]["findings_count"] = len(self.results["findings"])
        self.results["completed_at"] = datetime.now(timezone.utc).isoformat()

        # Print summary
        print("\n" + "="*70)
        print("TEST SUMMARY")
        print("="*70)
        print(f"Total Time: {self.results['metrics']['total_time']:.2f}s")
        print(f"Phases Completed: {self.results['metrics']['phases_completed']}/6")
        print(f"Errors: {len(self.results['errors'])}")
        print(f"Tools Available: {len(set(self.results['metrics']['tools_used']))}")
        print("="*70 + "\n")

        if self.results["errors"]:
            print("ERRORS:")
            for error in self.results["errors"]:
                print(f"  ✗ {error}")
            print()

        # Save results
        self.save_results()

        return len(self.results["errors"]) == 0

    def save_results(self):
        """Save test results to file"""
        results_dir = Path(__file__).parent.parent / "test_results"
        results_dir.mkdir(exist_ok=True)

        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        results_file = results_dir / f"autonomous_test_{timestamp}.json"

        with open(results_file, 'w') as f:
            json.dump(self.results, f, indent=2)

        print(f"✓ Test results saved to: {results_file}")


def main():
    parser = argparse.ArgumentParser(description="Test TazoSploit autonomous pentesting")
    parser.add_argument("--target", required=True, help="Target to test (IP or URL)")
    parser.add_argument("--type", default="web", help="Test type (web, network)")
    args = parser.parse_args()

    tester = AutonomousPentestTester(args.target, args.type)
    success = tester.run_all_tests()

    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
