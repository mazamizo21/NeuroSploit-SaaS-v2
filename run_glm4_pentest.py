#!/usr/bin/env python3
"""
Quick pentest against DVWA using GLM-4.7 via Zhipu API
"""

import os
import sys
import json
import requests
import subprocess

# GLM-4.7 API Configuration
API_URL = "https://api.z.ai/api/coding/paas/v4/chat/completions"
API_KEY = "6b4e170ce6a742ba94a16d586427b614.oTm1W1FEooGuO1K8"
MODEL = "glm-4.7"

# Target
TARGET = "http://localhost:8080"  # DVWA exposed port

def call_glm4(system_prompt: str, user_prompt: str, temperature: float = 0.2) -> str:
    """Call GLM-4.7 API"""
    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ],
        "temperature": temperature,
        "max_tokens": 2048
    }
    
    response = requests.post(API_URL, headers=headers, json=payload, timeout=1000)
    response.raise_for_status()
    
    data = response.json()
    return data["choices"][0]["message"]["content"]

def run_command(cmd: str) -> str:
    """Execute command in Kali container"""
    full_cmd = ["docker", "exec", "tazosploit-kali", "bash", "-c", cmd]
    result = subprocess.run(full_cmd, capture_output=True, text=True, timeout=120)
    return result.stdout + result.stderr

def main():
    print("=" * 70)
    print("TazoSploit GLM-4.7 Pentest - Target: DVWA")
    print("=" * 70)
    
    # Phase 1: Reconnaissance
    print("\n[PHASE 1] RECONNAISSANCE")
    print("-" * 50)
    
    # Test API connection first
    print("[*] Testing GLM-4.7 API connection...")
    try:
        test_response = call_glm4(
            "You are a helpful assistant.",
            "Respond with just 'OK' if you can read this.",
            temperature=0.1
        )
        print(f"[+] API Response: {test_response.strip()}")
    except Exception as e:
        print(f"[-] API Error: {e}")
        sys.exit(1)
    
    # Get recon commands from AI
    print("\n[*] Asking GLM-4.7 for reconnaissance commands...")
    recon_prompt = f"""You are a penetration tester. I need to scan {TARGET} (DVWA - Damn Vulnerable Web Application).

Generate 3 reconnaissance commands to run. Format as a JSON array of strings.
Example: ["curl -I {TARGET}", "nmap -sV localhost -p 8080"]

Only output the JSON array, nothing else."""

    try:
        recon_commands = call_glm4(
            "You are an expert penetration tester. Output only valid JSON.",
            recon_prompt
        )
        print(f"[+] AI suggested commands:\n{recon_commands}")
        
        # Parse and execute
        commands = json.loads(recon_commands.strip().replace("```json", "").replace("```", ""))
        for cmd in commands[:3]:
            print(f"\n[*] Executing: {cmd}")
            # Modify for docker context
            docker_cmd = cmd.replace("localhost:8080", "172.20.0.10:80").replace("http://localhost:8080", "http://172.20.0.10")
            output = run_command(docker_cmd)
            print(output[:500] if len(output) > 500 else output)
    except json.JSONDecodeError as e:
        print(f"[-] JSON parse error: {e}")
        print(f"    Raw response: {recon_commands[:200]}")
    except Exception as e:
        print(f"[-] Error: {e}")

    # Phase 2: Vulnerability Analysis
    print("\n[PHASE 2] VULNERABILITY ANALYSIS")
    print("-" * 50)
    
    vuln_prompt = f"""Analyze DVWA (Damn Vulnerable Web Application) at {TARGET}.
    
As a penetration tester, list the top 3 vulnerabilities to test on DVWA and provide a curl command for each.
Format as JSON: [{{"vuln": "name", "command": "curl ..."}}]

Only output JSON."""

    try:
        vuln_response = call_glm4(
            "You are an expert penetration tester specializing in web application security.",
            vuln_prompt
        )
        print(f"[+] AI vulnerability analysis:\n{vuln_response}")
        
        vulns = json.loads(vuln_response.strip().replace("```json", "").replace("```", ""))
        for vuln in vulns[:3]:
            print(f"\n[*] Testing: {vuln.get('vuln', 'Unknown')}")
            cmd = vuln.get('command', '').replace("localhost:8080", "172.20.0.10").replace("http://localhost:8080", "http://172.20.0.10")
            if cmd:
                output = run_command(cmd)
                print(output[:300] if len(output) > 300 else output)
    except json.JSONDecodeError as e:
        print(f"[-] JSON parse error: {e}")
    except Exception as e:
        print(f"[-] Error: {e}")

    # Phase 3: SQL Injection Test
    print("\n[PHASE 3] SQL INJECTION TEST")
    print("-" * 50)
    
    sqli_prompt = """Generate a curl command to test SQL injection on DVWA login page.
The target is http://172.20.0.10/login.php
Use a classic SQL injection payload.
Output only the curl command, nothing else."""

    try:
        sqli_cmd = call_glm4(
            "You are a penetration tester. Output only the command.",
            sqli_prompt
        )
        print(f"[+] AI generated SQLi command:\n{sqli_cmd}")
        
        # Execute the command
        cmd = sqli_cmd.strip().replace("```bash", "").replace("```", "").strip()
        if cmd.startswith("curl"):
            output = run_command(cmd)
            print(f"\n[*] Result:\n{output[:500]}")
    except Exception as e:
        print(f"[-] Error: {e}")

    print("\n" + "=" * 70)
    print("PENTEST COMPLETE")
    print("=" * 70)

if __name__ == "__main__":
    main()
